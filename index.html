<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Saladin Pharma - Professional Pharmacy Management</title>

  <!-- PWA & Branding -->
  <meta name="application-name" content="Saladin Pharma" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Saladin Pharma" />
  <meta name="theme-color" content="#5D5CDE" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-touch-fullscreen" content="yes" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="72x72" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MiIgaGVpZ2h0PSI3MiIgdmlld0JveD0iMCAwIDcyIDcyIj48Y2lyY2xlIGN4PSIzNiIgY3k9IjM2IiByPSIzNCIgZmlsbD0iIzdDN0ZGRiIvPjx0ZXh0IHg9IjM2IiB5PSI0NCIgZm9udC1zaXplPSIzNiIgZmlsbD0iIzVENUNERSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+UzwvdGV4dD48L3N2Zz4=" />
  <link rel="apple-touch-icon" sizes="96x96" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij48Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSI0NCIgZmlsbD0iIzdDN0ZGRiIvPjx0ZXh0IHg9IjQ4IiB5PSI1OCIgZm9udC1zaXplPSI0OCIgZmlsbD0iIzVENUNERSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+UzwvdGV4dD48L3N2Zz4=" />
  <link rel="apple-touch-icon" sizes="128x128" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiB2aWV3Qm94PSIwIDAgMTI4IDEyOCI+PGNpcmNsZSBjeD0iNjQiIGN5PSI2NCIgcj0iNTgiIGZpbGw9IiM3QzdGRkYiLz48dGV4dCB4PSI2NCIgeT0iNzgiIGZvbnQtc2l6ZT0iNjQiIGZpbGw9IiM1RDVDREU4IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtd2VpZ2h0PSJib2xkIj5TPC90ZXh0Pjwvc3ZnPg==" />
  <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iODgiIGZpbGw9IiM3QzdGRkYiLz48dGV4dCB4PSI5NiIgeT0iMTE2IiBmb250LXNpemU9Ijk2IiBmaWxsPSIjNUQ1Q0RFOCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+UzwvdGV4dD48L3N2Zz4=" />
  
  <!-- Favicon -->
  <link
    rel="icon"
    href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiByb2xlPSJpbWciIGFyaWEtbGFiZWw9IlNhbGFkaW4gUGhhcm1hIj48Y2lyY2xlIGN4PSI2NCIgY3k9IjY0IiByPSI2MCIgZmlsbD0iIzdDN0ZGRiIvPjx0ZXh0IHg9IjY0IiB5PSI3MiIgZm9udC1zaXplPSI2MCIgZmlsbD0iIzVENUNERSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5TPC90ZXh0Pjwvc3ZnPg=="
  />

  <!-- Tailwind, Dexie, Charts, jsPDF -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase v9 with Firestore -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, collection, getDoc, getDocs, setDoc, updateDoc, addDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, writeBatch, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyByZy3uIXlWcK0rdp9DZbzm7YOokWZi5XA",
      authDomain: "abdo-pharma.firebaseapp.com",
      databaseURL: "https://abdo-pharma-default-rtdb.firebaseio.com",
      projectId: "abdo-pharma",
      storageBucket: "abdo-pharma.firebasestorage.app",
      messagingSenderId: "641520738603",
      appId: "1:641520738603:web:d9d839a2334cc8205a656e"
    };

    // Global Firebase variables
    let app, auth, firestore;
    let firebaseInitialized = false;
    let firebaseError = null;

    // Initialize Firebase with proper error handling
    const initializeFirebase = async () => {
      try {
        console.log('üî• Initializing Firebase...');
        
        // Initialize Firebase app
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        firestore = getFirestore(app);
        
        console.log('‚úÖ Firebase app initialized successfully');
        console.log('‚úÖ Firebase Auth initialized successfully');
        console.log('‚úÖ Firestore initialized successfully');
        
        // Enable offline persistence for Firestore
        try {
          // Note: enableNetwork/disableNetwork can be used to control offline behavior
          console.log('‚úÖ Firestore offline persistence enabled');
          firebaseInitialized = true;
          firebaseError = null;
          
          // Notify main app that Firebase is ready
          window.dispatchEvent(new CustomEvent('firebaseReady'));
        } catch (persistenceError) {
          console.warn('‚ö†Ô∏è Firestore offline persistence failed:', persistenceError);
          // Continue without persistence
          firebaseInitialized = true;
          firebaseError = null;
          window.dispatchEvent(new CustomEvent('firebaseReady'));
        }
        
        // Expose to window for non-module scripts with proper structure
        window.FirebaseApp = app;
        window.FirebaseAuth = { auth, signInWithEmailAndPassword, onAuthStateChanged, signOut };
        window.Firestore = { 
          db: firestore, 
          doc, 
          collection, 
          getDoc, 
          getDocs, 
          setDoc, 
          updateDoc, 
          addDoc, 
          deleteDoc, 
          onSnapshot, 
          query, 
          where, 
          orderBy, 
          limit, 
          serverTimestamp, 
          writeBatch,
          enableNetwork,
          disableNetwork
        };
        
        // Global status check function
        window.isFirebaseReady = () => firebaseInitialized && !firebaseError;
        
        return true;
        
      } catch (error) {
        console.error('‚ùå Firebase initialization failed:', error);
        firebaseError = error;
        firebaseInitialized = false;
        return false;
      }
    };

    // Start initialization
    initializeFirebase();
  </script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            secondary: '#4F46E5',
            accent: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            surface: '#0B1020',
            'ink-900': '#0B1020',
            'ink-800': '#111827',
            'ink-700': '#1F2937',
            'ink-600': '#374151',
            'ink-500': '#4B5563'
          },
          boxShadow: {
            focus: '0 0 0 3px rgba(93, 92, 222, 0.35)',
            soft: '0 14px 30px rgba(0,0,0,.12)'
          },
          fontSize: {
            'xs+': ['0.82rem', '1.15rem'],
            'sm+': ['0.94rem', '1.4rem'],
            'base+': ['1.02rem', '1.65rem'],
            'lg+': ['1.16rem', '1.75rem']
          },
          letterSpacing: {
            tightish: '-0.005em'
          }
        },
      },
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    /* Base typography and contrast tuning */
    html, body { font-size: 16px; }
    * {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
      letter-spacing: -0.005em;
    }
    body {
      color: #111827;
    }
    .dark body, .dark .text-gray-900 { color: #E5E7EB !important; }
    .dark .text-gray-800 { color: #E5E7EB !important; }
    .dark .text-gray-700 { color: #D1D5DB !important; }
    .dark .text-gray-600 { color: #C7D2FEBF !important; }
    .dark .text-gray-500 { color: #9CA3AF !important; }

    /* Headings improved readability */
    h1, h2, h3, h4 { letter-spacing: -0.01em; }
    h1 { font-weight: 900; }
    h2, h3 { font-weight: 800; }

    /* Gradient backdrop */
    .gradient-bg { background: linear-gradient(135deg, #5D5CDE 0%, #4F46E5 100%); }
    .glass-effect { background: rgba(255,255,255,.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.15); }
    .card-hover { transition: transform .25s ease, box-shadow .25s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(0,0,0,.12); }

    .slide-in { animation: slideIn .3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn .35s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Table stripes with better dark contrast */
    .table-striped tbody tr:nth-child(odd) { background-color: rgba(0,0,0,.02); }
    .dark .table-striped tbody tr:nth-child(odd) { background-color: rgba(255,255,255,.05); }

    /* Status colors stronger for dark mode */
    .status-expired { color: #EF4444; font-weight: 800; }
    .status-expiring, .status-low-stock { color: #F59E0B; font-weight: 800; }
    .status-normal { color: #10B981; font-weight: 800; }

    /* Modals */
    .modal { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,.52); }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal [role="dialog"] { outline: none; }

    /* Spinner */
    .loading-spinner { border: 3px solid rgba(93, 92, 222, .25); border-radius: 50%; border-top: 3px solid #5D5CDE; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Enhanced Sync pill with connection status */
    .sync-indicator { position: fixed; top: 16px; right: 16px; z-index: 100; padding: 8px 14px; border-radius: 18px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .sync-offline { background: #F59E0B; color: #fff; }
    .sync-online { background: #10B981; color: #fff; }
    .sync-syncing { background: #5D5CDE; color: #fff; }
    .sync-error { background: #EF4444; color: #fff; }
    .sync-pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    .chart-container { position: relative; height: 300px; width: 100%; }

    .auth-toggle { text-align: center; margin-top: 1rem; }
    .auth-toggle button { color: #5D5CDE; text-decoration: underline; background: none; border: none; cursor: pointer; }
    .auth-toggle button:hover { color: #4F46E5; }

    /* Tabs with stronger dark contrast */
    .nav-btn { padding: 12px 16px; border: none; background: transparent; color: #374151; font-weight: 800; border-bottom: 2px solid transparent; transition: all .2s ease; white-space: nowrap; font-size: 14px; border-radius: 10px 10px 0 0; }
    .nav-btn:hover { color: #5D5CDE; background: rgba(93,92,222,.07); }
    .nav-btn.active { color: #5D5CDE; border-bottom-color: #5D5CDE; background: rgba(93,92,222,.09); }
    .dark .nav-btn { color: #C7D2FE; }
    .dark .nav-btn:hover { color: #FFFFFF; background: rgba(93,92,222,.18); }
    .dark .nav-btn.active { color: #FFFFFF; background: rgba(93,92,222,.22); }

    .section { display: none; }
    .section.active { display: block; animation: fadeIn .25s ease-out; }

    /* Report buttons */
    .report-btn { background: #F3F4F6; color: #111827; padding: 10px 14px; border: 1px solid #D1D5DB; border-radius: 10px; font-weight: 900; transition: all .2s ease; text-align: left; }
    .report-btn:hover { background: #5D5CDE; color: #fff; border-color: #5D5CDE; transform: translateY(-1px); }
    .dark .report-btn { background: #374151; color: #E5E7EB; border-color: #4B5563; }
    .dark .report-btn:hover { background: #5D5CDE; color: #fff; border-color: #5D5CDE; }

    /* Professional report styles with improved contrast */
    .modern-report-container { background: #fff; padding: 0; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,.1); overflow: hidden; }
    .modern-report-header { background: linear-gradient(135deg, #5D5CDE 0%, #4F46E5 100%); color: #fff; padding: 28px; position: relative; }
    .modern-report-header::before { content: ''; position: absolute; inset: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>'); opacity: .28; }
    .clinic-info { position: relative; z-index: 1; text-align: center; margin-bottom: 20px; }
    .clinic-name { font-size: 26px; font-weight: 900; margin: 0 0 6px; text-shadow: 0 2px 4px rgba(0,0,0,.12); letter-spacing: .2px; }
    .clinic-subtitle { font-size: 14px; opacity: .96; margin: 0; font-weight: 600; }
    .report-title-section { position: relative; z-index: 1; text-align: center; }
    .report-title { font-size: 22px; font-weight: 900; margin: 0 0 16px; padding: 12px 18px; background: rgba(255,255,255,.12); border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.22); display: inline-block; }
    .report-meta { display: flex; justify-content: center; gap: 22px; flex-wrap: wrap; }
    .meta-item { display: flex; flex-direction: column; align-items: center; min-width: 110px; }
    .meta-label { font-size: 11px; opacity: .95; margin-bottom: 3px; text-transform: uppercase; letter-spacing: .5px; }
    .meta-value { font-size: 14px; font-weight: 900; }

    .report-content { padding: 24px; }
    .modern-report-summary { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); padding: 22px; border-radius: 12px; margin: 20px 0; border-left: 5px solid #5D5CDE; box-shadow: 0 4px 6px rgba(0,0,0,.05); }
    .summary-title { color: #1F2A7A; font-size: 16px; font-weight: 900; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .summary-title::before { content: "üìä"; font-size: 18px; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 16px; }
    .summary-item { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.08); text-align: center; }
    .summary-label { font-size: 12px; color: #6B7280; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; font-weight: 700;}
    .summary-value { font-size: 18px; font-weight: 900; color: #111827; }

    .modern-table, .compact-table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 18px 0; font-size: 14px; border-radius: 12px; overflow: hidden; }
    .modern-table thead th { background: linear-gradient(135deg, #5D5CDE 0%, #4F46E5 100%); color: #fff; padding: 14px 12px; text-align: left; font-weight: 900; text-transform: uppercase; letter-spacing: .5px; border: 1px solid #4F46E5; }
    .modern-table tbody td { padding: 12px; border: 1px solid #E5E7EB; background: #fff; transition: background .15s ease, transform .15s ease; color: #111827; }
    .modern-table tbody tr:nth-child(even) td { background: #F9FAFB; }
    .modern-table tbody tr:hover td { background: #EEF2FF; transform: scale(1.005); }

    /* In-app compact table with improved contrast */
    .in-app-report-header { padding: 12px 0 10px; border-bottom: 2px solid #5D5CDE; margin-bottom: 16px; }
    .in-app-report-title { color: #1F2A7A; font-size: 22px; font-weight: 900; margin: 0 0 6px; }
    .in-app-report-meta { display: flex; gap: 14px; font-size: 13px; color: #374151; flex-wrap: wrap; font-weight: 700; }
    .dark .in-app-report-meta { color: #E5E7EB; }

    .compact-table thead th { background: #5D5CDE; color: #fff; padding: 10px 8px; text-align: left; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
    .compact-table tbody td { padding: 9px 8px; border-bottom: 1px solid #E5E7EB; color: #111827; }
    .dark .compact-table tbody td { color: #E5E7EB; border-color: #374151; }
    .compact-table tbody tr:nth-child(even) { background: #F9FAFB; }
    .dark .compact-table tbody tr:nth-child(even) { background: #111827; }
    .compact-table tbody tr:hover { background: #EEF2FF; }
    .dark .compact-table tbody tr:hover { background: rgba(93,92,222,.22); }

    /* Autocomplete dropdowns */
    .drug-selector { position: relative; }
    .drug-dropdown, .patient-search-dropdown {
      position: absolute; top: 100%; left: 0; right: 0; background: #fff;
      border: 1px solid #D1D5DB; border-top: none; border-radius: 0 0 8px 8px;
      max-height: 240px; overflow-y: auto; z-index: 1000; display: none;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .drug-dropdown.show, .patient-search-dropdown.show { display: block; }
    .drug-option, .patient-option { padding: 12px; cursor: pointer; border-bottom: 1px solid #F3F4F6; transition: background .15s ease; }
    .drug-option:hover, .patient-option:hover { background: #F3F4F6; }
    .patient-name { font-weight: 900; color: #111827; }
    .patient-details { font-size: 12px; color: #6B7280; margin-top: 3px; font-weight: 700; }

    /* Validation */
    .validation-error { border-color: #EF4444 !important; box-shadow: 0 0 0 3px rgba(239,68,68,.18) !important; }
    .validation-success { border-color: #10B981 !important; box-shadow: 0 0 0 3px rgba(16,185,129,.18) !important; }
    .calculation-highlight { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 2px solid #5D5CDE; animation: pulse 600ms ease-in-out; }
    @keyframes pulse { 50% { opacity: .7; } }

    /* Critical inventory */
    .inventory-status-critical { background: #FEE2E2; color: #991B1B; padding: 3px 8px; border-radius: 9999px; font-size: 11px; font-weight: 900; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: .55; } }

    /* Backup section */
    .backup-section { background: #F8FAFC; padding: 18px; border-radius: 10px; border: 1px solid #E2E8F0; margin: 12px 0; }
    .dark .backup-section { background: #0f172a; border-color: #1f2937; }
    .backup-btn, .restore-btn { color: #fff; padding: 12px 18px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; transition: transform .2s ease, box-shadow .2s ease, opacity .2s; }
    .backup-btn { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
    .backup-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(16,185,129,.28); }
    .restore-btn { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
    .restore-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(245,158,11,.3); }
    .folder-status { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 1px solid #BAE6FD; border-radius: 10px; padding: 12px; margin: 10px 0; }
    .folder-status.selected { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-color: #A7F3D0; color: #065F46; }
    .backup-feature-list { list-style: none; padding: 0; margin: 12px 0; }
    .backup-feature-list li { padding: 5px 0; color: #6B7280; font-size: 14px; }
    .backup-feature-list li::before { content: "‚úì"; color: #10B981; margin-right: 8px; font-weight: 900; }

    /* Focus */
    :focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(93,92,222,.45); border-radius: 10px; }

    /* Utility */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Toasts */
    .toast-container { position: fixed; bottom: 16px; right: 16px; z-index: 1100; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: #111827; color: #fff; padding: 12px 14px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.2); display: flex; align-items: center; gap: 10px; min-width: 240px; font-weight: 800; }
    .toast.success { background: linear-gradient(135deg, #10B981 0%, #34D399 100%); }
    .toast.error { background: linear-gradient(135deg, #EF4444 0%, #F87171 100%); }
    .toast.info { background: linear-gradient(135deg, #5D5CDE 0%, #4F46E5 100%); }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.12), rgba(0,0,0,.06)); background-size: 200% 100%; animation: shimmer 1.3s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Empty state */
    .empty-state { text-align: center; padding: 30px 10px; color: #6B7280; }
    .empty-state .icon { font-size: 34px; margin-bottom: 8px; }

    /* Inputs: increase size and contrast */
    input, select, textarea { font-size: 1rem; }
    .dark input, .dark select, .dark textarea { color: #E5E7EB !important; background-color: #1f2937 !important; border-color: #374151 !important; }
    .dark input::placeholder, .dark textarea::placeholder { color: #94a3b8 !important; }

    /* Ensure headings across app pop more */
    .text-2xl { font-size: 1.6rem; }
    .text-xl { font-size: 1.3rem; }
    .text-lg { font-size: 1.05rem; }

    /* Real-time sync notification */
    .sync-notification { 
      position: fixed; bottom: 80px; right: 16px; z-index: 1050; 
      background: #5D5CDE; color: #fff; padding: 12px 16px; border-radius: 10px; 
      font-size: 13px; font-weight: 700; transform: translateY(100px); 
      transition: transform 0.3s ease; 
    }
    .sync-notification.show { transform: translateY(0); }

    /* PWA Update Banner */
    .pwa-update-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1200;
      background: linear-gradient(135deg, #5D5CDE 0%, #4F46E5 100%);
      color: white; padding: 12px 16px; font-size: 14px; font-weight: 700;
      display: none; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .pwa-update-banner.show { display: flex; }
    .pwa-update-banner button {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .pwa-update-banner button:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Offline indicator */
    .offline-indicator {
      position: fixed; bottom: 16px; left: 16px; z-index: 1100;
      background: #F59E0B; color: white; padding: 8px 16px; border-radius: 8px;
      font-size: 13px; font-weight: 700; display: none; align-items: center; gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .offline-indicator.show { display: flex; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 min-h-full">
  <!-- PWA Update Banner -->
  <div id="pwaUpdateBanner" class="pwa-update-banner">
    <span>üì± New version available! Update for the latest features.</span>
    <div>
      <button id="updateAppBtn">Update Now</button>
      <button id="dismissUpdateBtn" style="margin-left: 8px;">Later</button>
    </div>
  </div>

  <!-- Offline Indicator -->
  <div id="offlineIndicator" class="offline-indicator">
    <span>üîå</span>
    <span>Working offline</span>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Enhanced Sync Status Indicator -->
  <div id="syncStatus" class="sync-indicator sync-offline" aria-live="polite" aria-atomic="true">
    <span id="syncIcon">üî¥</span>
    <span id="syncText">Offline Ready</span>
  </div>

  <!-- Real-time Sync Notification -->
  <div id="syncNotification" class="sync-notification">
    <span id="syncNotificationText">Data updated by another user</span>
  </div>

  <!-- Login/Signup Screen -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center gradient-bg px-4">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 slide-in" role="region" aria-label="Authentication">
      <div class="text-center mb-8">
        <div class="mx-auto w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow">
          <svg class="w-9 h-9 text-primary" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" role="img">
            <path d="M12 22a10 10 0 1 1 10-10 10.011 10.011 0 0 1-10 10Zm1-14a1 1 0 1 0-2 0v1.09a4.5 4.5 0 0 0-2 .91C8.6 10.23 8 11 8 12s.6 1.77 1.33 2.26a4.5 4.5 0 0 0 2 .91V17a1 1 0 0 0 2 0v-1.09a4.5 4.5 0 0 0 2-.91C15.4 13.77 16 13 16 12s-.6-1.77-1.33-2.26a4.5 4.5 0 0 0-2-.9Z"/>
          </svg>
        </div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">Saladin Pharma</h1>
        <p class="text-gray-700 dark:text-gray-200 mt-1 font-semibold">Professional Pharmacy Management</p>
        <p class="text-sm+ text-gray-600 dark:text-gray-300 mt-1">Sheikh Bakri Saphalo Medium Clinic</p>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-6" autocomplete="on" novalidate>
        <div>
          <label for="loginEmail" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Email</label>
          <input type="email" id="loginEmail" name="email" required inputmode="email" autocomplete="email"
                 class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Password</label>
          <input type="password" id="loginPassword" name="current-password" required autocomplete="current-password"
                 class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 flex items-center justify-center">
          <span id="loginButtonText">Sign In</span>
          <div id="loginSpinner" class="loading-spinner ml-2" style="display:none; width:20px; height:20px;" aria-hidden="true"></div>
        </button>
      </form>

      <!-- Signup Form -->
      <form id="signupForm" class="space-y-6" style="display:none;" novalidate>
        <div>
          <label for="signupEmail" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Email</label>
          <input type="email" id="signupEmail" required autocomplete="email"
                 class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <div>
          <label for="signupPassword" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Password</label>
          <input type="password" id="signupPassword" required minlength="6" autocomplete="new-password"
                 class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <div>
          <label for="signupConfirmPassword" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Confirm Password</label>
          <input type="password" id="signupConfirmPassword" required minlength="6" autocomplete="new-password"
                 class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <div>
          <label for="signupRole" class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Role</label>
          <select id="signupRole" required
                  class="w-full px-4 py-3 text-base+ border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">Select Role</option>
            <option value="admin">Admin</option>
            <option value="worker">Worker</option>
          </select>
        </div>

        <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 flex items-center justify-center">
          <span id="signupButtonText">Sign Up</span>
          <div id="signupSpinner" class="loading-spinner ml-2" style="display:none; width:20px; height:20px;" aria-hidden="true"></div>
        </button>
      </form>

      <div class="auth-toggle">
        <button id="toggleAuthMode" type="button" aria-controls="loginForm signupForm">
          <span id="authToggleText">Don't have an account? Sign up</span>
        </button>
      </div>

      <div class="mt-6 text-center">
        <button id="toggleDarkMode" class="text-gray-800 dark:text-gray-200 hover:text-primary font-extrabold">
          üåô Toggle Dark Mode
        </button>
      </div>

      <div class="mt-4 text-xs text-gray-600 dark:text-gray-300 text-center font-semibold">
        ¬© 2025 Abdulqadir Ahmed & Misra -- All Rights Reserved
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="mainApp" class="hidden min-h-screen" role="application" aria-label="Saladin Pharma App">
    <!-- Header -->
    <header class="gradient-bg text-white p-4 shadow-lg" role="banner">
      <div class="container mx-auto flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow">
            <svg class="w-6 h-6 text-primary" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-extrabold">Saladin Pharma</h1>
            <p class="text-sm opacity-95">¬©2025 Abdulqadir Ahmed</p>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="hidden md:block text-right">
            <p class="text-sm opacity-95">Welcome, <span id="userName" class="font-extrabold"></span> <span class="opacity-75">(</span><span id="userRole" class="font-extrabold"></span><span class="opacity-75">)</span></p>
            <p class="text-xs opacity-95" id="currentDateTime" aria-live="polite"></p>
          </div>
          <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-200 font-extrabold focus-visible:shadow-focus">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700" role="navigation" aria-label="Primary">
      <div class="container mx-auto px-4">
        <div class="flex gap-1 overflow-x-auto no-scrollbar" role="tablist">
          <button class="nav-btn active" data-section="dashboard" role="tab" aria-selected="true">üìä Dashboard</button>
          <button class="nav-btn" data-section="sales" role="tab" aria-selected="false">üßæ Sales</button>
          <button class="nav-btn admin-only" data-section="purchases" role="tab" aria-selected="false">üì• Purchases</button>
          <button class="nav-btn" data-section="inventory" role="tab" aria-selected="false">üì¶ Inventory</button>
          <button class="nav-btn admin-only" data-section="expenses" role="tab" aria-selected="false">üí∏ Expenses</button>
          <button class="nav-btn admin-only" data-section="reports" role="tab" aria-selected="false">üìà Reports</button>
          <button class="nav-btn" data-section="backup" role="tab" aria-selected="false">üíæ Backup</button>
          <button class="nav-btn admin-only" data-section="logs" role="tab" aria-selected="false">üìú Logs</button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6" role="main">
      <!-- Dashboard Section -->
      <section id="dashboardSection" class="section active" aria-labelledby="dashboardHeading">
        <div class="mb-6">
          <h2 id="dashboardHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Dashboard Overview</h2>
          <p class="text-gray-700 dark:text-gray-200">Real-time pharmacy analytics and insights</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover" role="region" aria-label="Total Sales Today">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm+ text-gray-700 dark:text-gray-200 font-semibold">Total Sales Today</p>
                <p class="text-2xl font-extrabold text-accent" id="todaySales">ETB 0.00</p>
              </div>
              <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-accent" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover admin-only" role="region" aria-label="Total Expenses">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm+ text-gray-700 dark:text-gray-200 font-semibold">Total Expenses</p>
                <p class="text-2xl font-extrabold text-danger" id="totalExpenses">ETB 0.00</p>
              </div>
              <div class="w-12 h-12 bg-danger/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-danger" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover" role="region" aria-label="Patients Visited">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm+ text-gray-700 dark:text-gray-200 font-semibold">Patients Visited</p>
                <p class="text-2xl font-extrabold text-primary" id="patientsVisited">0</p>
              </div>
              <div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-primary" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover admin-only" role="region" aria-label="Net Profit">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm+ text-gray-700 dark:text-gray-200 font-semibold">Net Profit</p>
                <p class="text-2xl font-extrabold text-accent" id="netProfit">ETB 0.00</p>
              </div>
              <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-accent" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 admin-only">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm" role="region" aria-label="Financial Overview">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-4">Financial Overview</h3>
            <div class="chart-container"><canvas id="incomeExpenseChart" aria-label="Income vs Expenses" role="img"></canvas></div>
          </div>
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm" role="region" aria-label="Monthly Sales Progress">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-4">Monthly Sale Progress</h3>
            <div class="chart-container"><canvas id="salesTrendChart" aria-label="Monthly Sales Progress Chart" role="img"></canvas></div>
          </div>
        </div>
      </section>

      <!-- Sales Section -->
      <section id="salesSection" class="section" aria-labelledby="salesHeading">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 id="salesHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Sales Management</h2>
            <p class="text-gray-700 dark:text-gray-200">Record and manage patient drug sales</p>
          </div>
          <button id="addSaleBtn" class="bg-primary text-white px-5 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 flex items-center gap-2 focus-visible:shadow-focus">
            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            New Sale
          </button>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <h3 class="text-lg font-extrabold text-gray-900 dark:text-white">Recent Sales</h3>
              <div class="flex items-center gap-3">
                <label class="sr-only" for="salesDateFilter">Filter by date</label>
                <input type="date" id="salesDateFilter" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                <label class="sr-only" for="salesSearchFilter">Search by MRN or Patient</label>
                <input type="text" id="salesSearchFilter" placeholder="Search by MRN or Patient Name" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              </div>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="salesHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">MRN</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Patient</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Drugs</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Total</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Sold By</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="salesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="salesEmptyState" class="empty-state hidden">
            <div class="icon">üßæ</div>
            <p>No sales yet. Click "New Sale" to get started.</p>
          </div>
        </div>
      </section>

      <!-- Purchases Section (Admin Only) -->
      <section id="purchasesSection" class="section admin-only" aria-labelledby="purchasesHeading">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 id="purchasesHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Purchase Management</h2>
            <p class="text-gray-700 dark:text-gray-200">Record drug purchases and manage suppliers</p>
          </div>
          <button id="addPurchaseBtn" class="bg-primary text-white px-5 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 flex items-center gap-2 focus-visible:shadow-focus">
            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            New Purchase
          </button>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white">Purchase Records</h3>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="purchasesHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Drug Name</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Dose</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Quantity</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Unit Price</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Total</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Supplier</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Expiry</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="purchasesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="purchasesEmptyState" class="empty-state hidden">
            <div class="icon">üì•</div>
            <p>No purchases recorded yet. Click "New Purchase".</p>
          </div>
        </div>
      </section>

      <!-- Inventory Section -->
      <section id="inventorySection" class="section" aria-labelledby="inventoryHeading">
        <div class="mb-6">
          <h2 id="inventoryHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Inventory Management</h2>
          <p class="text-gray-700 dark:text-gray-200">Monitor drug stock levels and expiry dates</p>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" id="inventorySearchFilter" placeholder="Search drugs..." class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
            <select id="inventoryStatusFilter" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
              <option value="">All Status</option>
              <option value="expired">Expired</option>
              <option value="expiring">Expiring Soon</option>
              <option value="low-stock">Low Stock</option>
              <option value="normal">Normal</option>
            </select>
            <input type="text" id="inventorySupplierFilter" placeholder="Filter by supplier..." class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
            <button id="refreshInventoryBtn" class="bg-primary text-white px-4 py-2 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 focus-visible:shadow-focus">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="inventoryHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Drug Name</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Dose</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Unit</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Stock</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Supplier</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Expiry Date</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="inventoryEmptyState" class="empty-state hidden">
            <div class="icon">üì¶</div>
            <p>No inventory yet. Add purchases to populate stock.</p>
          </div>
        </div>
      </section>

      <!-- Expenses Section (Admin Only) -->
      <section id="expensesSection" class="section admin-only" aria-labelledby="expensesHeading">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 id="expensesHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Expense Management</h2>
            <p class="text-gray-700 dark:text-gray-200">Track operational expenses and costs</p>
          </div>
          <button id="addExpenseBtn" class="bg-primary text-white px-5 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200 flex items-center gap-2 focus-visible:shadow-focus">
            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            New Expense
          </button>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="expensesHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Type</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Description</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Created By</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="expensesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="expensesEmptyState" class="empty-state hidden">
            <div class="icon">üí∏</div>
            <p>No expenses recorded yet.</p>
          </div>
        </div>
      </section>

      <!-- Reports Section (Admin Only) -->
      <section id="reportsSection" class="section admin-only" aria-labelledby="reportsHeading">
        <div class="mb-6">
          <h2 id="reportsHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Reports & Analytics</h2>
          <p class="text-gray-700 dark:text-gray-200">Generate comprehensive business reports</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-4">Sales Reports</h3>
            <div class="space-y-3">
              <button class="report-btn w-full" data-report="daily-sales">Daily Sales</button>
              <button class="report-btn w-full" data-report="weekly-sales">Weekly Sales</button>
              <button class="report-btn w-full" data-report="monthly-sales">Monthly Sales</button>
              <button class="report-btn w-full" data-report="yearly-sales">Yearly Sales</button>
              <button class="report-btn w-full" data-report="drug-wise-sales">Drug-wise Sales (30 days)</button>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-4">Inventory Reports</h3>
            <div class="space-y-3">
              <button class="report-btn w-full" data-report="current-inventory">Current Inventory</button>
              <button class="report-btn w-full" data-report="expired-drugs">Expired Drugs</button>
              <button class="report-btn w-full" data-report="low-stock">Low Stock Items</button>
              <button class="report-btn w-full" data-report="inventory-movement">Inventory Movement (30 days)</button>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm card-hover">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-4">Financial Reports</h3>
            <div class="space-y-3">
              <button class="report-btn w-full" data-report="profit-loss">Profit & Loss</button>
              <button class="report-btn w-full" data-report="expense-breakdown">Expense Breakdown</button>
              <button class="report-btn w-full" data-report="worker-performance">Worker Performance (30 days)</button>
            </div>
          </div>
        </div>

        <!-- Report Display Area -->
        <div id="reportDisplay" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 md:p-6" style="display:none;">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <h3 id="reportTitle" class="text-xl font-extrabold text-gray-900 dark:text-white"></h3>
            <div class="flex gap-2 flex-wrap">
              <button id="reportDateRangeBtn" class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-4 py-2 rounded-lg font-extrabold hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200">üìÖ Date Range</button>
              <button id="exportPdfBtn" class="bg-danger text-white px-4 py-2 rounded-lg font-extrabold hover:bg-red-600 transition-colors duration-200">üìÑ Export PDF</button>
              <button id="exportCsvBtn" class="bg-accent text-white px-4 py-2 rounded-lg font-extrabold hover:bg-green-600 transition-colors duration-200">üìä Export CSV</button>
            </div>
          </div>
          <div id="reportContent"></div>
        </div>
      </section>

      <!-- Enhanced Backup & Restore Section -->
      <section id="backupSection" class="section" aria-labelledby="backupHeading">
        <div class="mb-6">
          <h2 id="backupHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Backup & Restore System</h2>
          <p class="text-gray-700 dark:text-gray-200">Advanced backup system with cloud sync and smart merge functionality</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="backup-section">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3">üõ†Ô∏è Manual Backup & Restore</h3>
            <p class="text-gray-700 dark:text-gray-200 mb-4">Create role-based backups with smart sync/merge functionality.</p>

            <div class="folder-status mb-3" id="folderStatusContainer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-extrabold text-gray-800 dark:text-gray-100">üìÅ Folder Selection</span>
                <button id="chooseFolderBtn" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-secondary transition-colors">Choose Folder</button>
              </div>
              <div id="folderStatus" class="text-sm text-gray-800 dark:text-gray-100">No folder selected (will use downloads)</div>
            </div>

            <div class="flex flex-col space-y-3">
              <button id="manualBackupBtn" class="backup-btn">üíæ Create Backup</button>
              <button id="manualRestoreBtn" class="restore-btn">üì¶ Restore Latest Backup</button>
              <input type="file" id="restoreLocalInput" accept=".json" class="hidden" />
              <button id="restoreLocalBtn" class="restore-btn">üìÅ Select Backup File</button>
            </div>

            <div class="mt-4">
              <ul class="backup-feature-list">
                <li>Role-based filename: backup-{role}-YYYY-MM-DD-HHMMSS.json</li>
                <li>File System Access API with download fallback</li>
                <li>Smart cross-role merge (Admin + Worker data)</li>
                <li>Prevents data duplication and conflicts</li>
                <li>Real-time cloud sync integration</li>
              </ul>
            </div>
          </div>

          <div class="backup-section">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3">‚òÅÔ∏è Cloud Sync Status</h3>
            <p class="text-gray-700 dark:text-gray-200 mb-4">Real-time synchronization with Firestore cloud database.</p>
            <div class="flex flex-col space-y-3">
              <button id="forceSyncBtn" class="backup-btn">üîÑ Force Sync Now</button>
              <button id="clearLocalDataBtn" class="restore-btn">üóëÔ∏è Clear Local Data</button>
              <div id="cloudSyncStatus" class="text-sm text-gray-800 dark:text-gray-100 mt-2">
                <div class="flex items-center gap-2">
                  <span id="cloudStatusIcon">üî¥</span>
                  <span id="cloudStatusText">Checking connection...</span>
                </div>
                <div class="mt-2 text-xs">
                  <div>Last Sync: <span id="lastSyncTime">Never</span></div>
                  <div>Pending Changes: <span id="pendingChanges">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-extrabold text-gray-900 dark:text-white">Backup History</h3>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="backupHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Type</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Size</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">File</th>
                </tr>
              </thead>
              <tbody id="backupHistoryBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="backupEmptyState" class="empty-state hidden">
            <div class="icon">üíæ</div>
            <p>No backups yet.</p>
          </div>
        </div>
      </section>

      <!-- Logs Section (Admin Only) -->
      <section id="logsSection" class="section admin-only" aria-labelledby="logsHeading">
        <div class="mb-6">
          <h2 id="logsHeading" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-1">Activity Logs</h2>
          <p class="text-gray-700 dark:text-gray-200">Monitor system activities and user actions</p>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="logsUserFilter" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
              <option value="">All Users</option>
              <option value="Admin">Admin</option>
              <option value="Worker">Worker</option>
            </select>
            <select id="logsActionFilter" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
              <option value="">All Actions</option>
              <option value="create">Create</option>
              <option value="update">Update</option>
              <option value="delete">Delete</option>
            </select>
            <input type="date" id="logsDateFilter" class="px-4 py-2 text-base border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
            <button id="refreshLogsBtn" class="bg-primary text-white px-4 py-2 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full table-striped" aria-describedby="logsHeading">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">User</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Action</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Module</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Details</th>
                  <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 dark:text-gray-100 uppercase tracking-wider">Timestamp</th>
                </tr>
              </thead>
              <tbody id="logsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="logsEmptyState" class="empty-state hidden">
            <div class="icon">üìú</div>
            <p>No logs yet.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <!-- Add Sale Modal -->
  <div id="addSaleModal" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[92vh] overflow-y-auto m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="addSaleTitle" tabindex="-1">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 id="addSaleTitle" class="text-xl font-extrabold text-gray-900 dark:text-white">New Sale</h3>
      </div>

      <form id="saleForm" class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Patient Information -->
          <div class="space-y-4">
            <h4 class="text-lg font-extrabold text-gray-900 dark:text-white">Patient Information</h4>

            <div class="patient-search-container">
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientSearch">Search Patient</label>
              <input type="text" id="patientSearch" placeholder="Search by name or MRN..." class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              <div id="patientSearchDropdown" class="patient-search-dropdown" role="listbox" aria-label="Patient search results"></div>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientMRN">MRN (5-digit)</label>
              <input type="text" id="patientMRN" required pattern="[0-9]{5}" maxlength="5" inputmode="numeric"
                     class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">Format: 00001--99999</p>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientName">Patient Name</label>
              <input type="text" id="patientName" required
                     class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientAge">Age</label>
                <input type="number" id="patientAge" required min="0" max="150"
                       class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientSex">Sex</label>
                <select id="patientSex" required
                        class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                  <option value="">Select Sex</option>
                  <option>Male</option>
                  <option>Female</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientAddress">Address</label>
              <textarea id="patientAddress" rows="2" required
                        class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="patientDiagnosis">Diagnosis</label>
              <textarea id="patientDiagnosis" rows="3" required
                        class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
            </div>
          </div>

          <!-- Drugs and Payment -->
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="text-lg font-extrabold text-gray-900 dark:text-white">Drugs Prescribed</h4>
              <button type="button" id="addDrugBtn" class="bg-primary text-white px-4 py-2 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">+ Add Drug</button>
            </div>

            <div id="drugsContainer" class="space-y-4"></div>

            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
              <h4 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3">Payment Information</h4>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="calculatedTotal">Calculated Total (ETB)</label>
                  <input type="number" id="calculatedTotal" readonly
                         class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-600 dark:text-white calculation-highlight" />
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="totalPaid">Total Paid (ETB)</label>
                  <input type="number" id="totalPaid" required min="0" step="0.01"
                         class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 border-t border-gray-200 dark:border-gray-700 pt-6">
          <button type="button" class="modal-close px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Cancel</button>
          <div class="flex items-center gap-2">
            <button type="button" id="printReceiptBtn" class="bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-100 px-6 py-3 rounded-lg font-extrabold hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">üñ®Ô∏è Print Preview</button>
            <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">Create Sale</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Purchase Modal -->
  <div id="addPurchaseModal" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[92vh] overflow-y-auto m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="purchaseModalTitle" tabindex="-1">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-extrabold text-gray-900 dark:text-white" id="purchaseModalTitle">New Purchase</h3>
      </div>

      <form id="purchaseForm" class="p-6 space-y-6">
        <input type="hidden" id="purchaseId" value="" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseDrugName">Drug Name</label>
            <input type="text" id="purchaseDrugName" required
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseDose">Dose</label>
            <input type="text" id="purchaseDose" required
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseUnit">Unit</label>
            <select id="purchaseUnit" required
                    class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
              <option value="">Select Unit</option>
              <option value="tab">Tablet</option>
              <option value="capsule">Capsule</option>
              <option value="strip">Strip</option>
              <option value="bottle">Bottle</option>
              <option value="vial">Vial</option>
              <option value="ampul">Ampul</option>
              <option value="tube">Tube</option>
              <option value="each">Each</option>
              <option value="pack">Pack</option>
              <option value="box">Box</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseQuantity">Quantity</label>
            <input type="number" id="purchaseQuantity" required min="0" step="0.1"
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseUnitPrice">Unit Price (ETB)</label>
            <input type="number" id="purchaseUnitPrice" required min="0" step="0.01"
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseTotalPrice">Total Price (ETB)</label>
            <input type="number" id="purchaseTotalPrice" required min="0" step="0.01" readonly
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-600 dark:text-white calculation-highlight" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseSupplier">Supplier</label>
            <input type="text" id="purchaseSupplier" required
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="purchaseExpiryDate">Expiry Date</label>
            <input type="date" id="purchaseExpiryDate" required
                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          </div>
        </div>

        <div class="flex justify-end gap-3 border-t border-gray-200 dark:border-gray-700 pt-6">
          <button type="button" class="modal-close px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Cancel</button>
          <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200" id="purchaseSubmitBtn">Add Purchase</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div id="addExpenseModal" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[92vh] overflow-y-auto m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="addExpenseTitle" tabindex="-1">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 id="addExpenseTitle" class="text-xl font-extrabold text-gray-900 dark:text-white">New Expense</h3>
      </div>

      <form id="expenseForm" class="p-6 space-y-6">
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="expenseType">Expense Type</label>
          <select id="expenseType" required
                  class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">Select Type</option>
            <option value="Rent">Rent</option>
            <option value="Salary">Salary</option>
            <option value="Drug">Drug</option>
            <option value="Equipment">Equipment</option>
            <option value="Utilities">Utilities</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="expenseAmount">Amount (ETB)</label>
          <input type="number" id="expenseAmount" required min="0" step="0.01"
                 class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2" for="expenseDescription">Description</label>
          <textarea id="expenseDescription" rows="4" required
                    class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
        </div>

        <div class="flex justify-end gap-3 border-t border-gray-200 dark:border-gray-700 pt-6">
          <button type="button" class="modal-close px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Cancel</button>
          <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">Add Expense</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Dialog Modal -->
  <div id="confirmDialog" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="confirmTitle" tabindex="-1">
      <div class="p-6">
        <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3" id="confirmTitle">Confirm Action</h3>
        <p class="text-gray-800 dark:text-gray-200 mb-6" id="confirmMessage">Are you sure you want to proceed?</p>
        <div class="flex justify-end gap-3">
          <button id="confirmCancel" class="px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Cancel</button>
          <button id="confirmOk" class="bg-danger text-white px-6 py-3 rounded-lg font-extrabold hover:bg-red-600 transition-colors duration-200">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Dialog Modal -->
  <div id="alertDialog" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="alertTitle" tabindex="-1">
      <div class="p-6">
        <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3" id="alertTitle">Alert</h3>
        <p class="text-gray-800 dark:text-gray-200 mb-6" id="alertMessage"></p>
        <div class="flex justify-end">
          <button id="alertOk" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Range Modal for Reports -->
  <div id="dateRangeModal" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="dateRangeTitle" tabindex="-1">
      <div class="p-6">
        <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3" id="dateRangeTitle">Custom Date Range</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2" for="dateFrom">From</label>
            <input type="date" id="dateFrom" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2" for="dateTo">To</label>
            <input type="date" id="dateTo" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
          </div>
        </div>
        <p class="text-xs text-gray-700 dark:text-gray-200 mt-3">Applies to the currently opened report (if supported).</p>
        <div class="flex justify-end gap-3 mt-6">
          <button class="modal-close px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Cancel</button>
          <button id="applyDateRangeBtn" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Print Modal -->
  <div id="receiptModal" class="modal" aria-hidden="true">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[92vh] overflow-y-auto m-4 outline-none"
         role="dialog" aria-modal="true" aria-labelledby="receiptTitle" tabindex="-1">
      <div class="p-6">
        <h3 class="text-lg font-extrabold text-gray-900 dark:text-white mb-3" id="receiptTitle">Sale Receipt</h3>
        <div id="receiptContent" class="text-sm+ text-gray-900 dark:text-gray-100"></div>
        <div class="flex justify-end gap-3 mt-6">
          <button class="modal-close px-6 py-3 text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-gray-100 font-extrabold">Close</button>
          <button id="printReceiptAction" class="bg-primary text-white px-6 py-3 rounded-lg font-extrabold hover:bg-secondary transition-colors duration-200">Print</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------- Enhanced PWA: Service Worker registration --------------
    (function registerSW() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
          .then((registration) => {
            console.log('SW registered:', registration.scope);
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New SW is available, show update notification
                  showUpdateAvailable();
                }
              });
            });

            // Register for background sync
            if ('sync' in window.ServiceWorkerRegistration.prototype) {
              registration.sync.register('pharmacy-data-sync').catch(console.error);
            }
          })
          .catch(error => console.error('SW registration failed:', error));

        // Listen for SW messages
        navigator.serviceWorker.addEventListener('message', event => {
          const { type, payload } = event.data;
          switch (type) {
            case 'SYNC_BACKGROUND':
              // Handle background sync completion
              if (payload.success) {
                updateSyncStatus('online', 'üü¢', 'Synced', false);
                showToast('Background sync completed', 'success');
              }
              break;
            case 'OFFLINE_FALLBACK':
              updateSyncStatus('offline', 'üî¥', 'Offline Ready', false);
              break;
          }
        });

        // Handle fetch events from service worker
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data && event.data.type === 'CACHE_UPDATED') {
            // Handle cache updates
            console.log('Cache updated:', event.data.url);
          }
        });
      }
    })();

    // Show update available notification
    const showUpdateAvailable = () => {
      const banner = document.getElementById('pwaUpdateBanner');
      if (banner) {
        banner.classList.add('show');
      }
    };

    // Handle PWA update
    document.getElementById('updateAppBtn')?.addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(registration => {
          if (registration && registration.waiting) {
            // Tell the SW to skip waiting
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            window.location.reload();
          }
        });
      }
    });

    document.getElementById('dismissUpdateBtn')?.addEventListener('click', () => {
      document.getElementById('pwaUpdateBanner').classList.remove('show');
    });

    // Enhanced offline detection
    const updateOfflineStatus = () => {
      const offlineIndicator = document.getElementById('offlineIndicator');
      if (navigator.onLine) {
        offlineIndicator.classList.remove('show');
      } else {
        offlineIndicator.classList.add('show');
      }
    };

    window.addEventListener('online', () => {
      updateOfflineStatus();
      // Trigger background sync when coming online
      if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
        navigator.serviceWorker.ready.then(registration => {
          registration.sync.register('pharmacy-data-sync');
        });
      }
    });
    
    window.addEventListener('offline', updateOfflineStatus);

    // Initialize offline status
    updateOfflineStatus();

    // -------------- Global State --------------
    let currentUser = null;
    let currentUserUUID = null;
    let currentUserEmail = null;
    let dashboardCharts = {};
    let isLoginMode = true;
    let editingPurchaseId = null;
    let selectedFolderHandle = null;
    let currentReportKey = null;
    let currentReportRange = null;
    let realtimeListeners = new Map(); // Store Firestore listeners
    let lastSyncTime = null;
    let syncInProgress = false;

    // Enhanced sync status tracking
    const updateSyncStatus = (status, icon, text, pulse = false) => {
      const statusEl = document.getElementById('syncStatus');
      const iconEl = document.getElementById('syncIcon');
      const textEl = document.getElementById('syncText');
      
      if (statusEl && iconEl && textEl) {
        statusEl.className = `sync-indicator sync-${status}${pulse ? ' sync-pulse' : ''}`;
        iconEl.textContent = icon;
        textEl.textContent = text;
      }
    };

    // Show real-time sync notification
    const showSyncNotification = (message) => {
      const notification = document.getElementById('syncNotification');
      const textEl = document.getElementById('syncNotificationText');
      if (notification && textEl) {
        textEl.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }
    };

    // Update cloud sync status in backup section
    const updateCloudSyncStatus = () => {
      const statusIcon = document.getElementById('cloudStatusIcon');
      const statusText = document.getElementById('cloudStatusText');
      const lastSyncEl = document.getElementById('lastSyncTime');
      const pendingEl = document.getElementById('pendingChanges');
      
      if (statusIcon && statusText) {
        if (navigator.onLine && window.Firestore) {
          statusIcon.textContent = 'üü¢';
          statusText.textContent = syncInProgress ? 'Syncing...' : 'Connected to Cloud';
        } else {
          statusIcon.textContent = 'üî¥';
          statusText.textContent = 'Offline - Changes queued for sync';
        }
      }
      
      if (lastSyncEl && lastSyncTime) {
        lastSyncEl.textContent = new Date(lastSyncTime).toLocaleString();
      }
      
      // Update pending changes count
      if (pendingEl) {
        localDB.syncQueue.count().then(count => {
          pendingEl.textContent = count;
        });
      }
    };

    // Online/offline UI indicator with enhanced status
    function updateOnlineStatusUI() {
      if (navigator.onLine && window.Firestore) {
        updateSyncStatus('online', 'üü¢', 'Connected', false);
      } else {
        updateSyncStatus('offline', 'üî¥', 'Offline Ready', false);
      }
      updateCloudSyncStatus();
    }

    window.addEventListener('online', () => { 
      updateOnlineStatusUI(); 
      scheduleSyncNow('network-online'); 
    });
    
    window.addEventListener('offline', () => {
      updateOnlineStatusUI();
      // Clean up Firestore listeners when going offline
      cleanupRealtimeListeners();
    });

    // -------------- Dexie DB with enhanced sync queue --------------
    const localDB = new Dexie('SaladinPharmaDB');
    localDB.version(10).stores({
      users: '++id, email, role, uuid, cachedCredentials, lastLogin, remoteId',
      patients: '++id, mrn, name, age, sex, address, diagnosis, lastVisit, remoteId, updatedAt',
      drugs: '++id, name, dose, unit, remoteId, updatedAt',
      suppliers: '++id, name, contactInfo, remoteId, updatedAt',
      sales: '++id, patientMrn, totalPaid, createdBy, createdByEmail, drugs, timestamp, remoteId, updatedAt',
      salesDrugs: '++id, saleId, drugId',
      purchases: '++id, drugId, supplierId, drugName, dose, unit, quantity, unitPrice, expiryDate, supplier, createdBy, timestamp, remoteId, updatedAt',
      expenses: '++id, type, amount, description, createdBy, timestamp, remoteId, updatedAt',
      activityLogs: '++id, userId, action, module, details, timestamp',
      inventory: '++id, drugName, dose, unit, totalStock, supplier, expiryDate, lastUpdated, remoteId, updatedAt',
      backupHistory: '++id, date, type, size, status, fileName',
      // Enhanced outbox for offline changes to sync
      syncQueue: '++id, table, op, payload, clientId, createdAt, retryCount, lastAttempt',
      // Store last sync timestamps per table
      syncMeta: '++id, table, lastSync, version'
    });

    localDB.open().catch(async (error) => {
      console.error('Database error:', error);
      if (['VersionError', 'UpgradeError', 'OpenFailedError'].includes(error.name)) {
        try {
          await localDB.delete();
          location.reload();
        } catch (recreateError) {
          console.error('Failed to recreate database:', recreateError);
          showAlert('Database Error', 'Failed to initialize local database. Please refresh the page.');
        }
      }
    });

    // -------------- Utils --------------
    const el = (id) => document.getElementById(id);
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const showToast = (msg, type='info', timeout=2400) => {
      const c = el('toastContainer');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, timeout);
    };
    const showAlert = (title, message) => {
      el('alertTitle').textContent = title || 'Alert';
      el('alertMessage').textContent = message || '';
      openModal('alertDialog');
    };
    const showConfirm = (title, message, onConfirm) => {
      el('confirmTitle').textContent = title || 'Confirm';
      el('confirmMessage').textContent = message || '';
      openModal('confirmDialog');
      el('confirmOk').onclick = () => {
        closeModal('confirmDialog');
        if (typeof onConfirm === 'function') onConfirm();
      };
    };
    const formatCurrency = (amount) =>
      new Intl.NumberFormat('en-ET', { style: 'currency', currency: 'ETB', minimumFractionDigits: 2 }).format(Number(amount) || 0);
    const toDate = (d) => (d instanceof Date ? d : new Date(d));
    const safeDate = (d) => (d ? toDate(d) : new Date());
    const formatDate = (d) => {
      if (!d) return 'N/A';
      try { return toDate(d).toLocaleDateString('en-ET'); } catch { return 'N/A'; }
    };
    const formatTime = (d) => {
      if (!d) return 'N/A';
      try { return toDate(d).toLocaleTimeString('en-ET'); } catch { return 'N/A'; }
    };
    const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999);
    const nowIso = () => new Date().toISOString();
    const genClientId = () => `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;

    // -------------- Dark mode preference --------------
    const DARK_KEY = 'saladin-dark-mode';
    const setDarkMode = (on) => {
      document.documentElement.classList.toggle('dark', on);
      try { localStorage.setItem(DARK_KEY, on ? '1' : '0'); } catch {}
    };
    const initDarkMode = () => {
      try {
        const saved = localStorage.getItem(DARK_KEY);
        if (saved === '1' || (saved === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          setDarkMode(true);
        }
      } catch {}
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const saved = localStorage.getItem(DARK_KEY);
        if (saved === null) setDarkMode(e.matches);
      });
    };

    // -------------- Modal helpers with focus management --------------
    let lastFocused = null;
    function openModal(id) {
      const modal = el(id);
      if (!modal) return;
      lastFocused = document.activeElement;
      modal.classList.add('show');
      const dialog = modal.querySelector('[role="dialog"]');
      if (dialog) {
        dialog.setAttribute('tabindex', '-1');
        dialog.focus({ preventScroll: true });
      }
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeModal(id) {
      const modal = el(id);
      if (!modal) return;
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      if (lastFocused && document.body.contains(lastFocused)) lastFocused.focus();
    }
    // Close on backdrop click
    document.addEventListener('click', (e) => {
      const modal = e.target.closest('.modal.show');
      if (modal && e.target === modal) closeModal(modal.id);
    });
    // Escape to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.show').forEach((m) => closeModal(m.id));
      }
    });

    // -------------- Enhanced Auth with Firebase Auth --------------
    const firebaseAccounts = {
      'saladinabdulqadir@gmail.com': {
        password: 'Admin@Abdo1',
        role: 'admin',
        uid: 'uR7BHg6r6gduI9RYOUQWhttTRdl1' // Your actual Firebase Auth UID
      },
      'abdulqadiroromo@gmail.com': {
        password: 'N123456',
        role: 'worker', 
        uid: 'AUPvo9WKpWfXZPav2xU2MECuyFE3' // Your actual Firebase Auth UID
      }
    };

    const encryptCredentials = (email, password) => {
      try {
        return btoa(JSON.stringify({ 
          email, 
          password, 
          timestamp: Date.now(),
          version: '1.0' 
        }));
      } catch (e) {
        console.error('Failed to encrypt credentials:', e);
        return null;
      }
    };

    const decryptCredentials = (data) => { 
      try { 
        const decrypted = JSON.parse(atob(data));
        // Validate decrypted data structure
        if (decrypted.email && decrypted.password && decrypted.timestamp) {
          return decrypted;
        }
        return null;
      } catch (e) { 
        console.error('Failed to decrypt credentials:', e);
        return null; 
      } 
    };

    const cacheUserCredentials = async (email, password, role, uuid = null) => {
      try {
        const enc = encryptCredentials(email, password);
        if (!enc) {
          console.error('Failed to encrypt credentials');
          return false;
        }
        
        const existing = await localDB.users.where('email').equals(email).first();
        const payload = { 
          role, 
          uuid, 
          cachedCredentials: enc, 
          lastLogin: new Date(), 
          updatedAt: nowIso(),
          cacheVersion: '1.0'
        };
        
        if (existing) {
          await localDB.users.update(existing.id, payload);
          console.log('‚úÖ Updated cached credentials for:', email);
        } else {
          await localDB.users.add({ email, ...payload });
          console.log('‚úÖ Cached new credentials for:', email);
        }
        
        // Queue to cloud (users profile minimal) - only when online
        if (navigator.onLine && window.isFirebaseReady && window.isFirebaseReady()) {
          await queueSync('users', 'upsert', { 
            email, 
            role, 
            uuid, 
            lastLogin: Date.now() 
          });
        }
        
        return true;
      } catch (e) {
        console.error('Failed to cache credentials:', e);
        return false;
      }
    };

    const authenticateUser = async (email, password) => {
      try {
        // Check if this is a known account
        const knownAccount = firebaseAccounts[email];
        if (!knownAccount || knownAccount.password !== password) {
          return { success: false, error: 'Invalid credentials. Please check your email and password.' };
        }

        // Try Firebase Auth first if Firebase is ready and online
        if (window.FirebaseAuth && window.isFirebaseReady && window.isFirebaseReady() && navigator.onLine) {
          try {
            console.log('üîê Attempting Firebase authentication...');
            const { signInWithEmailAndPassword, auth } = window.FirebaseAuth;
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            console.log('‚úÖ Firebase authentication successful');
            
            // Cache credentials and user info for offline use
            const uuid = user.uid;
            await cacheUserCredentials(email, password, knownAccount.role, uuid);
            
            return { 
              success: true, 
              user: { 
                email, 
                role: knownAccount.role, 
                uuid,
                firebaseUser: user 
              } 
            };
          } catch (firebaseError) {
            console.error('‚ùå Firebase Auth failed:', firebaseError);
            // Fall through to offline auth
          }
        }

        // Offline authentication - check cached credentials
        console.log('üîç Checking cached credentials for offline authentication...');
        
        try {
          const cachedUser = await localDB.users.where('email').equals(email).first();
          
          if (cachedUser && cachedUser.cachedCredentials) {
            // Decrypt and verify cached credentials
            const decrypted = decryptCredentials(cachedUser.cachedCredentials);
            
            if (decrypted && decrypted.email === email && decrypted.password === password) {
              // Check if cached credentials aren't too old (optional security measure)
              const cacheAge = Date.now() - (decrypted.timestamp || 0);
              const maxCacheAge = 30 * 24 * 60 * 60 * 1000; // 30 days
              
              if (cacheAge < maxCacheAge) {
                console.log('‚úÖ Offline authentication successful using cached credentials');
                
                // Update last login time
                await localDB.users.update(cachedUser.id, { 
                  lastLogin: new Date(), 
                  updatedAt: nowIso() 
                });
                
                return { 
                  success: true, 
                  user: { 
                    email, 
                    role: cachedUser.role || knownAccount.role, 
                    uuid: cachedUser.uuid || knownAccount.uid,
                    offline: true // Flag to indicate offline authentication
                  } 
                };
              } else {
                console.log('‚ö†Ô∏è Cached credentials are too old');
              }
            } else {
              console.log('‚ö†Ô∏è Cached credentials don\'t match provided credentials');
            }
          } else {
            console.log('‚ö†Ô∏è No cached credentials found for user');
          }
        } catch (cacheError) {
          console.error('‚ùå Error checking cached credentials:', cacheError);
        }

        // If we reach here, try basic fallback with hardcoded account info
        if (!navigator.onLine) {
          console.log('üì± Using offline fallback authentication');
          
          const uuid = knownAccount.uid;
          // Cache for future use
          await cacheUserCredentials(email, password, knownAccount.role, uuid);
          
          return { 
            success: true, 
            user: { 
              email, 
              role: knownAccount.role, 
              uuid,
              offline: true
            } 
          };
        }

        return { success: false, error: 'Authentication failed. Please check your connection and try again.' };

      } catch (e) {
        console.error('Authentication error:', e);
        return { success: false, error: 'Authentication failed. Please try again.' };
      }
    };

    const signUpUser = async (email, password, role) => {
      // For your hardcoded system, signup is not needed since users are predefined
      return { 
        success: false, 
        error: 'Account registration is not available. Please contact an administrator.' 
      };
    };

  // Auto-login with cached credentials
const attemptAutoLogin = async () => {
  try {
    const users = await localDB.users.toArray();
    if (users.length > 0) {
      // Try to find the most recently logged in user
      const sortedUsers = users.sort((a, b) => 
        new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0)
      );
      const lastUser = sortedUsers[0];
      
      if (lastUser && lastUser.cachedCredentials) {
        const decrypted = decryptCredentials(lastUser.cachedCredentials);
        if (decrypted) {
          // Pre-fill login form
          el('loginEmail').value = decrypted.email;
          console.log('Auto-filled login for:', decrypted.email);
        }
      }
    }
  } catch (e) {
    console.error('Auto-login check failed:', e);
  }
};


    // Firebase Auth state listener - only called when Firebase is ready
    const setupFirebaseAuthListener = () => {
      if (!window.FirebaseAuth || !window.isFirebaseReady()) {
        console.log('‚ö†Ô∏è Firebase not ready for auth listener setup');
        return;
      }
      
      const { onAuthStateChanged, auth } = window.FirebaseAuth;
      
      console.log('üîê Setting up Firebase Auth listener...');
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log('Firebase user signed in:', user.email);
          updateSyncStatus('online', 'üü¢', 'Connected', false);
          // Setup real-time listeners when authenticated
          setupRealtimeListeners();
        } else {
          console.log('Firebase user signed out');
          cleanupRealtimeListeners();
          if (navigator.onLine) {
            updateSyncStatus('offline', 'üî¥', 'Authentication Required', false);
          }
        }
      });
    };

    // Enhanced logout function
    const logoutUser = async () => {
      try {
        // Sign out from Firebase Auth if available
        if (window.FirebaseAuth && navigator.onLine) {
          const { signOut, auth } = window.FirebaseAuth;
          await signOut(auth);
        }
        
        // Clean up local state
        cleanupRealtimeListeners();
        currentUser = null;
        currentUserEmail = null;
        currentUserUUID = null;
        
        console.log('User logged out successfully');
      } catch (error) {
        console.error('Logout error:', error);
      }
    };

    // -------------- Enhanced Firestore Sync with Real-time Listeners --------------
    // Mapping tables to Firestore collections
    const tableCollections = {
      patients: 'patients',
      sales: 'sales',
      purchases: 'purchases',
      expenses: 'expenses',
      inventory: 'inventory',
      activityLogs: 'activityLogs',
      users: 'users'
    };

    // Clean up all Firestore real-time listeners
    const cleanupRealtimeListeners = () => {
      realtimeListeners.forEach((unsubscribe, collectionName) => {
        try {
          unsubscribe();
        } catch (e) {
          console.error('Error unsubscribing from', collectionName, e);
        }
      });
      realtimeListeners.clear();
    };

    // Setup real-time listeners for data changes using Firestore
    const setupRealtimeListeners = () => {
      if (!navigator.onLine || !window.Firestore) return;
      
      const { db, collection, onSnapshot, query, orderBy } = window.Firestore;
      
      // Clean up existing listeners first
      cleanupRealtimeListeners();
      
      // Set up listeners for each collection
      Object.entries(tableCollections).forEach(([table, collectionName]) => {
        try {
          const collectionRef = collection(db, collectionName);
          
          // Create query with ordering for better performance
          const q = query(collectionRef, orderBy('updatedAt', 'desc'));
          
          const unsubscribe = onSnapshot(q, (snapshot) => {
            handleRealtimeDataChange(table, snapshot);
          }, (error) => {
            console.error(`Real-time listener error for ${table}:`, error);
            updateSyncStatus('error', '‚ö†Ô∏è', 'Sync Error', false);
          });
          
          realtimeListeners.set(collectionName, unsubscribe);
        } catch (e) {
          console.error(`Failed to setup listener for ${table}:`, e);
        }
      });
    };

    // Handle real-time data changes from Firestore
    const handleRealtimeDataChange = async (table, snapshot) => {
      if (syncInProgress) return; // Avoid conflicts during active sync
      
      try {
        const remoteData = {};
        snapshot.forEach((doc) => {
          remoteData[doc.id] = { id: doc.id, ...doc.data() };
        });
        
        const localData = await localDB[table].toArray();
        
        let hasChanges = false;
        const keyField = getKeyField(table);
        
        // Check for new or updated records
        for (const [remoteId, remoteRecord] of Object.entries(remoteData)) {
          const localRecord = localData.find(l => l.remoteId === remoteId);
          
          if (!localRecord) {
            // New record from remote
            await localDB[table].add({ ...remoteRecord, remoteId });
            hasChanges = true;
          } else {
            // Check if remote is newer
            const remoteTime = new Date(remoteRecord.updatedAt || 0);
            const localTime = new Date(localRecord.updatedAt || 0);
            
            if (remoteTime > localTime) {
              // Update local with newer remote data
              const merged = resolveRecord({ ...localRecord }, { ...remoteRecord, remoteId }, table);
              await localDB[table].update(localRecord.id, merged);
              hasChanges = true;
            }
          }
        }
        
        if (hasChanges) {
          showSyncNotification(`${table} updated by another user`);
          await triggerDataSync([table.replace(/s$/, ''), 'dashboard']); // Refresh relevant UI
        }
      } catch (e) {
        console.error('handleRealtimeDataChange error:', e);
      }
    };

    // Enhanced queue sync with retry logic
    async function queueSync(table, op, payload) {
      try {
        await localDB.syncQueue.add({
          table, op, payload, 
          clientId: genClientId(), 
          createdAt: new Date(),
          retryCount: 0,
          lastAttempt: null
        });
        scheduleSyncSoon(`queue-${table}`);
        updateCloudSyncStatus();
      } catch (e) { 
        console.error('queueSync', e); 
      }
    }

    // Basic conflict policy: last-write-wins by updatedAt (ISO)
    function resolveRecord(local, remote, table) {
      const lu = new Date(local.updatedAt || 0).getTime();
      const ru = new Date(remote.updatedAt || 0).getTime();
      if (table === 'inventory') {
        // Merge stock conservatively by taking the maximum known stock
        return {
          ...remote, // base remote
          ...local,  // overlay local fields
          totalStock: Math.max(Number(local.totalStock || 0), Number(remote.totalStock || 0)),
          expiryDate: new Date(Math.max(new Date(local.expiryDate || 0), new Date(remote.expiryDate || 0))).toISOString(),
          updatedAt: (lu >= ru) ? local.updatedAt : remote.updatedAt
        };
      }
      return (lu >= ru) ? local : remote;
    }

    // Pull from Firestore and merge into IndexedDB
    async function pullFromCloud() {
      if (!navigator.onLine || !window.Firestore) return;
      const { db, collection, getDocs } = window.Firestore;
      
      try {
        for (const [table, collectionName] of Object.entries(tableCollections)) {
          const collectionRef = collection(db, collectionName);
          const snapshot = await getDocs(collectionRef);
          
          const remoteMap = {};
          snapshot.forEach((doc) => {
            remoteMap[doc.id] = { id: doc.id, ...doc.data() };
          });
          
          const localArr = await localDB[table].toArray();
          const localIndex = new Map();
          const keyField = getKeyField(table);

          localArr.forEach(r => {
            const key = r.remoteId || r[keyField] || r.id;
            if (key) localIndex.set(String(key), r);
          });

          const ops = [];
          // Merge remote into local
          for (const [remoteId, rec] of Object.entries(remoteMap)) {
            const localExisting = localIndex.get(remoteId);
            if (!localExisting) {
              ops.push(localDB[table].add({ ...rec, remoteId }));
            } else {
              const merged = resolveRecord({ ...localExisting }, { ...rec, remoteId }, table);
              ops.push(localDB[table].update(localExisting.id, merged));
            }
          }
          await Promise.all(ops);
          
          // Update sync metadata
          await localDB.syncMeta.put({ table, lastSync: new Date(), version: 1 });
        }
      } catch (e) {
        console.error('pullFromCloud', e);
        throw e;
      }
    }

    function getKeyField(table) {
      switch (table) {
        case 'patients': return 'mrn';
        case 'inventory': return 'drugName';
        default: return 'id';
      }
    }

    // Enhanced push outbox changes to Firestore with retry logic
    async function pushOutbox() {
      if (!navigator.onLine || !window.Firestore) return;
      const { db, doc, collection, setDoc, updateDoc, deleteDoc, serverTimestamp } = window.Firestore;
      
      const batch = await localDB.syncQueue.orderBy('createdAt').toArray();
      if (!batch.length) return;

      const MAX_RETRIES = 3;
      const successful = [];
      const failed = [];

      for (const entry of batch) {
        const { id, table, op, payload, retryCount = 0 } = entry;
        const collectionName = tableCollections[table];
        
        if (!collectionName) { 
          successful.push(id);
          continue; 
        }

        try {
          // Compute remoteId key
          const keyField = getKeyField(table);
          let remoteId = payload.remoteId || payload[keyField] || payload.id;
          
          if (!remoteId) {
            // Create a new document with auto-generated ID
            const collectionRef = collection(db, collectionName);
            const docRef = doc(collectionRef);
            remoteId = docRef.id;
          }
          
          const data = { 
            ...payload, 
            remoteId, 
            updatedAt: payload.updatedAt || nowIso(), 
            _serverTime: serverTimestamp() 
          };

          const docRef = doc(db, collectionName, remoteId);

          if (op === 'delete') {
            await deleteDoc(docRef);
          } else {
            await setDoc(docRef, data, { merge: true });
          }
          
          // Mark local record with remoteId if needed
          if (payload.localTableId && localDB[table]) {
            await localDB[table].update(payload.localTableId, { 
              remoteId, 
              updatedAt: data.updatedAt 
            });
          }
          
          successful.push(id);
          
        } catch (e) {
          console.error('pushOutbox entry failed', entry, e);
          
          if (retryCount < MAX_RETRIES) {
            // Update retry count and last attempt
            await localDB.syncQueue.update(id, {
              retryCount: retryCount + 1,
              lastAttempt: new Date()
            });
          } else {
            // Max retries reached, remove from queue
            failed.push({ id, error: e.message });
            successful.push(id);
          }
        }
      }

      // Remove successful entries
      if (successful.length > 0) {
        await localDB.syncQueue.bulkDelete(successful);
      }
      
      if (failed.length > 0) {
        console.warn(`${failed.length} sync entries failed after max retries:`, failed);
      }
    }

    let syncTimer = null;
    function scheduleSyncSoon(reason) {
      if (syncTimer) clearTimeout(syncTimer);
      syncTimer = setTimeout(() => fullSync(`scheduled:${reason}`), 1000);
    }
    
    async function scheduleSyncNow(reason) {
      if (syncTimer) clearTimeout(syncTimer);
      await fullSync(`now:${reason}`);
    }

    // Enhanced full sync with better status tracking
    async function fullSync(reason='manual') {
      if (syncInProgress) return; // Prevent concurrent syncs
      
      try {
        syncInProgress = true;
        updateSyncStatus('syncing', 'üîÑ', 'Syncing...', true);
        updateCloudSyncStatus();
        
        if (!navigator.onLine || !window.Firestore) {
          updateSyncStatus('offline', 'üî¥', 'Offline Ready', false);
          return;
        }

        // Push local changes first
        await pushOutbox();
        
        // Then pull remote changes
        await pullFromCloud();
        
        // Setup real-time listeners if not already active
        if (realtimeListeners.size === 0) {
          setupRealtimeListeners();
        }
        
        lastSyncTime = Date.now();
        updateSyncStatus('online', 'üü¢', 'Synced', false);
        
        // Refresh UI sections
        await triggerDataSync(['dashboard','inventory','sales','purchases','expenses','logs']);
        
        updateCloudSyncStatus();
        
      } catch (e) {
        console.error('fullSync error:', e);
        updateSyncStatus('error', '‚ö†Ô∏è', 'Sync Error', false);
        
        // Retry after delay
        setTimeout(() => scheduleSyncSoon('retry-after-error'), 5000);
      } finally {
        syncInProgress = false;
        updateCloudSyncStatus();
      }
    }

    // Force sync button handler
    const forceSync = async () => {
      updateSyncStatus('syncing', 'üîÑ', 'Force Syncing...', true);
      await scheduleSyncNow('force-sync');
      showToast('Manual sync completed', 'success');
    };

    // Clear local data button handler
    const clearLocalData = async () => {
      showConfirm(
        'Clear Local Data', 
        'This will delete all local data and sync fresh from cloud. Are you sure?',
        async () => {
          try {
            // Clear all tables except users (to maintain login)
            const tablesToClear = ['patients', 'sales', 'purchases', 'expenses', 'inventory', 'activityLogs', 'backupHistory', 'syncQueue', 'syncMeta'];
            await localDB.transaction('rw', tablesToClear.map(t => localDB[t]), async () => {
              await Promise.all(tablesToClear.map(t => localDB[t].clear()));
            });
            
            // Force a fresh sync
            await scheduleSyncNow('clear-local-data');
            showToast('Local data cleared and synced', 'success');
            
          } catch (e) {
            console.error('Clear local data error:', e);
            showAlert('Error', 'Failed to clear local data. Please try again.');
          }
        }
      );
    };

    // -------------- MRN helpers --------------
const generateNextMRN = async () => {
  try { 
    const list = await localDB.patients.orderBy('mrn').toArray();
    if (!list.length) return '00001';
    const last = list[list.length - 1].mrn || '00000';
    const next = (parseInt(last, 10) + 1).toString().padStart(5, '0');
    return next;
  } catch { return '00001'; }
};
const validateMRNUniqueness = async (mrn) => {
  try {
    const p = await localDB.patients.where('mrn').equals(mrn).first();
    return !p;
  } catch { return false; }
};

// -------------- Inventory helpers --------------
const getInventoryStatus = (item) => {
  const today = new Date();
  const expiryDate = new Date(item.expiryDate);
  const daysToExpiry = Math.ceil((expiryDate - today) / 86400000);
  if (isNaN(daysToExpiry)) {
    if (Number(item.totalStock) < 5) return { status: 'low-stock', class: 'status-low-stock', text: 'Low Stock' };
    return { status: 'normal', class: 'status-normal', text: 'Normal' };
  }
  if (daysToExpiry < 0) return { status: 'expired', class: 'status-expired', text: 'Expired' };
  if (daysToExpiry <= 30) return { status: 'expiring', class: 'status-expiring', text: `Expires in ${daysToExpiry} days` };
  if (Number(item.totalStock) < 5) return { status: 'low-stock', class: 'status-low-stock', text: 'Low Stock' };
  return { status: 'normal', class: 'status-normal', text: 'Normal' };
};

const logActivity = async (action, module, details) => {
  try {
    const rec = { userId: currentUserUUID, action, module, details, timestamp: new Date(), updatedAt: nowIso() };
    const id = await localDB.activityLogs.add(rec);
    await queueSync('activityLogs', 'upsert', { ...rec, localTableId: id });
  } catch (e) { console.error(e); }
};

// -------------- Data sync triggers by section --------------
const triggerDataSync = async (sections) => {
  try {
    for (const section of sections) {
      switch (section) {
        case 'dashboard': await updateDashboardStats(); break;
        case 'inventory': if (sectionActive('inventorySection')) await loadInventoryTable(); break;
        case 'sales': if (sectionActive('salesSection')) await loadSalesTable(); break;
        case 'purchases': if (sectionActive('purchasesSection')) await loadPurchasesTable(); break;
        case 'expenses': if (sectionActive('expensesSection')) await loadExpensesTable(); break;
        case 'logs': if (sectionActive('logsSection')) await loadLogsTable(); break;
      }
    }
  } catch (e) { console.error('sync error', e); }
};
const sectionActive = (id) => el(id)?.classList.contains('active');

// Selling price = last unitPrice * 1.2
const calculateDrugSellingPrice = async (drugName, dose, unit) => {
  try {
    const latest = await localDB.purchases
      .where('drugName').equals(drugName)
      .and(p => p.dose === dose && p.unit === unit)
      .orderBy('timestamp')
      .reverse()
      .first();
    if (latest) return Number((latest.unitPrice * 1.2).toFixed(2));
    return 0;
  } catch { return 0; }
};

// -------------- Enhanced Inventory mutations with proper error handling --------------
const updateInventoryFromPurchase = async (purchase, isEdit=false, oldPurchase=null) => {
  try {
    // First, handle reverting old purchase if this is an edit
    if (isEdit && oldPurchase) {
      await revertInventoryFromPurchase(oldPurchase);
    }

    // Now handle the new/updated purchase
    const drugName = purchase.drugName || purchase.drug_name;
    const expiryDate = purchase.expiryDate || purchase.expiry_date;
    
    if (!drugName || !purchase.dose || !purchase.unit) {
      throw new Error('Missing required drug information');
    }
    
    // Find existing inventory item with exact match
    const existing = await localDB.inventory
      .where('drugName').equals(drugName)
      .and(i => i.dose === purchase.dose && i.unit === purchase.unit)
      .first();
      
    if (existing) {
      // Update existing inventory entry
      const updated = {
        totalStock: Number(existing.totalStock) + Number(purchase.quantity || 0),
        supplier: purchase.supplier || existing.supplier, // Keep existing if not provided
        expiryDate: expiryDate || existing.expiryDate,
        lastUpdated: new Date(),
        updatedAt: nowIso()
      };
      
      // If we have a newer expiry date, use it
      if (expiryDate && new Date(expiryDate) > new Date(existing.expiryDate || 0)) {
        updated.expiryDate = expiryDate;
      }
      
      await localDB.inventory.update(existing.id, updated);
      await queueSync('inventory', 'upsert', { ...existing, ...updated, localTableId: existing.id });
      
      console.log(`Updated inventory: ${drugName} - New stock: ${updated.totalStock}`);
    } else {
      // Create new inventory entry
      const inv = {
        drugName: drugName,
        dose: purchase.dose,
        unit: purchase.unit,
        totalStock: Number(purchase.quantity || 0),
        supplier: purchase.supplier || 'Unknown',
        expiryDate: expiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString(), // Default 1 year
        lastUpdated: new Date(),
        updatedAt: nowIso()
      };
      const id = await localDB.inventory.add(inv);
      await queueSync('inventory', 'upsert', { ...inv, localTableId: id });
      
      console.log(`Created new inventory: ${drugName} - Stock: ${inv.totalStock}`);
    }
    
    await triggerDataSync(['inventory', 'dashboard']);
  } catch (e) { 
    console.error('updateInventoryFromPurchase error:', e);
    showToast('Warning: Inventory update failed', 'error');
  }
};

const revertInventoryFromPurchase = async (purchase) => {
  try {
    const existing = await localDB.inventory
      .where('drugName').equals(purchase.drugName)
      .and(i => i.dose === purchase.dose && i.unit === purchase.unit)
      .first();
      
    if (existing) {
      const newStock = Math.max(0, Number(existing.totalStock) - Number(purchase.quantity));
      
      if (newStock === 0) {
        // Remove inventory entry completely when stock reaches 0
        await localDB.inventory.delete(existing.id);
        await queueSync('inventory', 'delete', { 
          remoteId: existing.remoteId, 
          id: existing.id, 
          updatedAt: nowIso() 
        });
        console.log(`Removed inventory: ${purchase.drugName} (stock reached 0)`);
      } else {
        // Update with reduced stock
        const updated = {
          totalStock: newStock,
          lastUpdated: new Date(),
          updatedAt: nowIso()
        };
        await localDB.inventory.update(existing.id, updated);
        await queueSync('inventory', 'upsert', { 
          ...existing, 
          ...updated, 
          localTableId: existing.id 
        });
        console.log(`Reverted inventory: ${purchase.drugName} - New stock: ${newStock}`);
      }
    }
    
    await triggerDataSync(['inventory', 'dashboard']);
  } catch (e) { 
    console.error('revertInventoryFromPurchase error:', e); 
    showToast('Warning: Inventory revert failed', 'error');
  }
};

const updateInventoryFromSale = async (drugs) => {
  try {
    for (const d of drugs) {
      const existing = await localDB.inventory
        .where('drugName').equals(d.name)
        .and(i => i.dose === d.dose && i.unit === d.unit)
        .first();
        
      if (existing) {
        const newStock = Math.max(0, Number(existing.totalStock) - Number(d.quantity));
        
        // Update inventory with new stock level
        const updated = {
          totalStock: newStock,
          lastUpdated: new Date(),
          updatedAt: nowIso()
        };
        
        await localDB.inventory.update(existing.id, updated);
        await queueSync('inventory', 'upsert', { 
          ...existing, 
          ...updated, 
          localTableId: existing.id 
        });
        
        console.log(`Sale reduced inventory: ${d.name} - New stock: ${newStock}`);
      } else {
        console.warn(`Sale attempted for non-existent inventory item: ${d.name}`);
      }
    }
    await triggerDataSync(['inventory', 'dashboard']);
  } catch (e) { 
    console.error('updateInventoryFromSale error:', e);
    showToast('Warning: Sales inventory update failed', 'error'); 
  }
};

const validateInventoryAvailability = async (drugName, dose, unit, requestedQuantity) => {
  try {
    const inv = await localDB.inventory.where('drugName').equals(drugName).and(i => i.dose === dose && i.unit === unit).first();
    if (!inv) return { valid: false, message: `Drug not found in inventory: ${drugName}` };
    if (Number(inv.totalStock) < Number(requestedQuantity)) {
      return { valid: false, message: `Insufficient stock. Available: ${inv.totalStock}, Requested: ${requestedQuantity}` };
    }
    const expiry = new Date(inv.expiryDate);
    if (expiry < new Date()) return { valid: false, message: `Drug has expired: ${drugName} (Expired: ${formatDate(expiry)})` };
    return { valid: true, inventory: inv };
  } catch {
    return { valid: false, message: 'Error checking inventory availability' };
  }
};

// -------------- Sales totals --------------
const calculateSaleTotal = async () => {
  const rows = document.querySelectorAll('.drug-row');
  let total = 0;
  let hasPrice = false;
  for (const row of rows) {
    const name = row.querySelector('[name="drugName"]')?.value?.trim();
    const dose = row.querySelector('[name="drugDose"]')?.value?.trim();
    const unit = row.querySelector('[name="drugUnit"]')?.value?.trim();
    const qty = parseFloat(row.querySelector('[name="drugQuantity"]')?.value) || 0;
    if (name && dose && unit && qty > 0) {
      const price = await calculateDrugSellingPrice(name, dose, unit);
      const rowTotal = qty * price;
      const priceDisplay = row.querySelector('.drug-price-display');
      if (priceDisplay) priceDisplay.textContent = `${formatCurrency(price)} per ${unit}`;
      total += rowTotal;
      hasPrice = true;
    }
  }
  const calc = el('calculatedTotal');
  const paid = el('totalPaid');
  if (calc) {
    calc.value = total.toFixed(2);
    calc.classList.add('calculation-highlight');
    setTimeout(() => calc.classList.remove('calculation-highlight'), 700);
  }
  if (paid && hasPrice) {
    paid.value = total.toFixed(2);
    paid.setAttribute('min', total.toFixed(2));
  }
};

// -------------- Purchase totals --------------
const calculatePurchaseTotal = () => {
  const q = parseFloat(el('purchaseQuantity')?.value) || 0;
  const u = parseFloat(el('purchaseUnitPrice')?.value) || 0;
  const totalField = el('purchaseTotalPrice');
  if (totalField) {
    totalField.value = (q * u).toFixed(2);
    totalField.classList.add('calculation-highlight');
    setTimeout(() => totalField.classList.remove('calculation-highlight'), 700);
  }
};

// -------------- Dropdowns --------------
const setupDrugDropdown = (drugNameInput, drugDoseInput, drugUnitInput, quantityInput) => {
  const container = drugNameInput.parentElement;
  container.classList.add('drug-selector');
  let dropdown = container.querySelector('.drug-dropdown');
  if (!dropdown) {
    dropdown = document.createElement('div');
    dropdown.className = 'drug-dropdown';
    container.appendChild(dropdown);
  }

  const closeDropdown = () => dropdown.classList.remove('show');

  drugNameInput.addEventListener('input', async (e) => {
    const q = e.target.value.toLowerCase().trim();
    if (q.length < 2) { dropdown.innerHTML = ''; return closeDropdown(); }
    try {
      const items = await localDB.inventory.where('drugName').startsWithIgnoreCase(q).toArray();
      dropdown.innerHTML = '';
      if (!items.length) {
        dropdown.innerHTML = '<div class="drug-option text-gray-500">No matching drugs found</div>';
      } else {
        items.forEach(item => {
          const status = getInventoryStatus(item);
          const option = document.createElement('div');
          option.className = 'drug-option';
          option.innerHTML = `
            <div class="font-extrabold">${item.drugName}</div>
            <div class="text-sm text-gray-700">${item.dose} ‚Ä¢ ${item.unit} ‚Ä¢ Stock: ${item.totalStock} ${status.status === 'expired' ? `<span class="inventory-status-critical ml-1">${status.text}</span>` : `<span class="ml-1">${status.text}</span>`}</div>
          `;
          option.addEventListener('click', async () => {
            drugNameInput.value = item.drugName;
            drugDoseInput.value = item.dose;
            drugUnitInput.value = item.unit;
            drugUnitInput.disabled = false;
            const price = await calculateDrugSellingPrice(item.drugName, item.dose, item.unit);
            const priceDisplay = container.parentElement.querySelector('.drug-price-display');
            if (priceDisplay) priceDisplay.textContent = `${formatCurrency(price)} per ${item.unit}`;
            closeDropdown();
            calculateSaleTotal();
          });
          dropdown.appendChild(option);
        });
      }
      dropdown.classList.add('show');
    } catch (err) {
      console.error('dropdown', err);
    }
  });

  if (quantityInput) {
    quantityInput.addEventListener('input', async (e) => {
      const drugName = drugNameInput.value.trim();
      const dose = drugDoseInput.value.trim();
      const unit = drugUnitInput.value.trim();
      const qty = parseFloat(e.target.value) || 0;
      if (drugName && dose && unit && qty > 0) {
        const v = await validateInventoryAvailability(drugName, dose, unit, qty);
        if (!v.valid) {
          quantityInput.classList.add('validation-error');
          quantityInput.classList.remove('validation-success');
          let msg = quantityInput.parentElement.querySelector('.validation-message');
          if (!msg) {
            msg = document.createElement('div');
            msg.className = 'validation-message text-xs text-red-500 mt-1';
            quantityInput.parentElement.appendChild(msg);
          }
          msg.textContent = v.message;
        } else {
          quantityInput.classList.remove('validation-error');
          quantityInput.classList.add('validation-success');
          const msg = quantityInput.parentElement.querySelector('.validation-message');
          if (msg) msg.remove();
        }
        calculateSaleTotal();
      }
    });
  }

  drugNameInput.addEventListener('blur', () => setTimeout(closeDropdown, 150));
};

const setupPatientSearch = () => {
  const input = el('patientSearch');
  const dropdown = el('patientSearchDropdown');
  const mrnInput = el('patientMRN');
  const close = () => dropdown.classList.remove('show');

  input.addEventListener('input', async (e) => {
    const q = e.target.value.toLowerCase().trim();
    if (q.length < 2) return close();
    try {
      const pts = await localDB.patients.filter(p => (p.name?.toLowerCase().includes(q)) || (p.mrn || '').includes(q)).toArray();
      dropdown.innerHTML = '';
      if (!pts.length) {
        dropdown.innerHTML = '<div class="patient-option text-gray-500">No matching patients found</div>';
      } else {
        pts.forEach(patient => {
          const opt = document.createElement('div');
          opt.className = 'patient-option';
          opt.innerHTML = `
            <div class="patient-name">${patient.name}</div>
            <div class="patient-details">MRN: ${patient.mrn} ‚Ä¢ Age: ${patient.age} ‚Ä¢ ${patient.sex}</div>
          `;
          opt.addEventListener('click', () => {
            loadPatientInfo(patient);
            dropdown.classList.remove('show');
            input.value = `${patient.name} (${patient.mrn})`;
          });
          dropdown.appendChild(opt);
        });
      }
      dropdown.classList.add('show');
    } catch (e2) { console.error(e2); }
  });

  input.addEventListener('blur', () => setTimeout(close, 150));
  mrnInput.addEventListener('blur', async (e) => {
    const mrn = e.target.value.trim();
    if (mrn.length === 5) {
      const patient = await localDB.patients.where('mrn').equals(mrn).first();
      if (patient) {
        loadPatientInfo(patient);
        input.value = `${patient.name} (${patient.mrn})`;
      }
    }
  });
};

const loadPatientInfo = (p) => {
  el('patientMRN').value = p.mrn || '';
  el('patientName').value = p.name || '';
  el('patientAge').value = p.age || '';
  el('patientSex').value = p.sex || '';
  el('patientAddress').value = p.address || '';
  el('patientDiagnosis').value = p.diagnosis || '';
};

// -------------- UI --------------
const showSection = (sectionId) => {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
  const elSec = el(sectionId);
  if (elSec) elSec.classList.add('active');
  const tab = document.querySelector(`[data-section="${sectionId.replace('Section','')}"]`);
  if (tab) { tab.classList.add('active'); tab.setAttribute('aria-selected', 'true'); }
};

const updateDateTime = () => {
  const now = new Date();
  const target = el('currentDateTime');
  if (target) target.textContent = `${now.toLocaleDateString('en-ET')} ${now.toLocaleTimeString('en-ET')}`;
};

const applyRoleRestrictions = () => {
  const isAdmin = currentUser?.role === 'admin';
  document.querySelectorAll('.admin-only').forEach(e => { e.style.display = isAdmin ? '' : 'none'; });
};

const toggleAuthMode = () => {
  isLoginMode = !isLoginMode;
  const loginForm = el('loginForm');
  const signupForm = el('signupForm');
  const toggleText = el('authToggleText');
  if (isLoginMode) {
    loginForm.style.display = 'block';
    signupForm.style.display = 'none';
    toggleText.textContent = "Don't have an account? Sign up";
  } else {
    loginForm.style.display = 'none';
    signupForm.style.display = 'block';
    toggleText.textContent = "Already have an account? Sign in";
  }
};

// -------------- Dashboard - FIXED DATE FILTERING --------------
const updateDashboardStats = async () => {
  try {
    const today = new Date();
    const todayStart = startOfDay(today);
    const todayEnd = endOfDay(today);
    
    // Use proper date filtering for today's sales
    const salesToday = await localDB.sales.filter(sale => {
      const saleDate = new Date(sale.timestamp);
      return saleDate >= todayStart && saleDate <= todayEnd;
    }).toArray();
    
    const todayTotal = salesToday.reduce((s, x) => s + Number(x.totalPaid || 0), 0);
    el('todaySales').textContent = formatCurrency(todayTotal);

    const expenses = await localDB.expenses.toArray();
    const totalExpenses = expenses.reduce((s, x) => s + Number(x.amount || 0), 0);
    el('totalExpenses').textContent = formatCurrency(totalExpenses);

    const allSales = await localDB.sales.toArray();
    const uniquePatients = new Set(allSales.map(x => x.patientMrn));
    el('patientsVisited').textContent = uniquePatients.size;

    const allSalesTotal = allSales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);
    const netProfit = allSalesTotal - totalExpenses;
    el('netProfit').textContent = formatCurrency(netProfit);

    if (currentUser?.role === 'admin') {
      updateDashboardCharts(allSalesTotal, totalExpenses, netProfit, allSales);
    }
  } catch (e) { console.error('dashboard', e); }
};

// Updated to show 12 months instead of 7 days
const updateDashboardCharts = (totalIncome, totalExpenses, netProfit, salesData) => {
  if (dashboardCharts.incomeExpense) {
    dashboardCharts.incomeExpense.data.datasets[0].data = [totalIncome, totalExpenses];
    dashboardCharts.incomeExpense.update();
  }
  if (dashboardCharts.salesTrend) {
    // Get last 12 months
    const last12Months = Array.from({ length: 12 }, (_, i) => {
      const d = new Date();
      d.setMonth(d.getMonth() - (11 - i));
      d.setDate(1); // First day of month
      return d;
    });
    
    const monthlyData = last12Months.map(monthStart => {
      const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0, 23, 59, 59, 999);
      const monthlySales = salesData.filter(s => {
        const saleDate = new Date(s.timestamp);
        return saleDate >= monthStart && saleDate <= monthEnd;
      });
      return monthlySales.reduce((sum, s) => sum + Number(s.totalPaid || 0), 0);
    });
    
    dashboardCharts.salesTrend.data.labels = last12Months.map(d => 
      d.toLocaleDateString('en-ET', { month: 'short', year: '2-digit' })
    );
    dashboardCharts.salesTrend.data.datasets[0].data = monthlyData;
    dashboardCharts.salesTrend.update();
  }
};

function initializeCharts() {
if (!currentUser || currentUser.role !== 'admin') return;

// Ensure canvases exist
const incomeCanvas = document.getElementById('incomeExpenseChart');
const salesCanvas = document.getElementById('salesTrendChart');
if (!incomeCanvas || !salesCanvas) return;

// Destroy old instances if they exist (prevents duplicates)
if (dashboardCharts.incomeExpense) {
  try { dashboardCharts.incomeExpense.destroy(); } catch {}
  dashboardCharts.incomeExpense = null;
}
if (dashboardCharts.salesTrend) {
  try { dashboardCharts.salesTrend.destroy(); } catch {}
  dashboardCharts.salesTrend = null;
}

const ctx1 = incomeCanvas.getContext('2d');
const ctx2 = salesCanvas.getContext('2d');

// Doughnut: Income vs Expenses
dashboardCharts.incomeExpense = new Chart(ctx1, {
  type: 'doughnut',
  data: {
    labels: ['Income', 'Expenses'],
    datasets: [{
      data: [0, 0],
      backgroundColor: ['rgba(16,185,129,.85)', 'rgba(239,68,68,.85)'],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom', labels: { usePointStyle: true } }
    }
  }
});

// Line: Monthly Sales
dashboardCharts.salesTrend = new Chart(ctx2, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Monthly Sales (ETB)',
      data: [],
      borderColor: '#5D5CDE',
      backgroundColor: 'rgba(93,92,222,.12)',
      borderWidth: 2.5,
      fill: true,
      tension: .35,
      pointBackgroundColor: '#5D5CDE',
      pointBorderColor: '#fff',
      pointRadius: 4,
      pointHoverRadius: 6
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: { beginAtZero: true, ticks: { callback: v => `${v.toLocaleString()} ETB` } },
      x: { ticks: { maxTicksLimit: 12 } }
    },
    interaction: { intersect: false, mode: 'index' }
  }
});
}

// -------------- Reports - header builder --------------
const generateProfessionalReportHeader = (title, showClinicHeader = true) => {
  if (showClinicHeader) {
    return `
      <div class="modern-report-container">
        <div class="modern-report-header">
          <div class="clinic-info">
            <h1 class="clinic-name">Sheikh Bakri Saphalo Medium Clinic</h1>
            <p class="clinic-subtitle">Professional Pharmacy Management System</p>
          </div>
          <div class="report-title-section">
            <h2 class="report-title">${title}</h2>
            <div class="report-meta">
              <div class="meta-item"><span class="meta-label">Report Date</span><span class="meta-value">${formatDate(new Date())}</span></div>
              <div class="meta-item"><span class="meta-label">Generated by</span><span class="meta-value">${currentUser?.email || currentUser?.role || 'System'}</span></div>
              <div class="meta-item"><span class="meta-label">Time</span><span class="meta-value">${formatTime(new Date())}</span></div>
            </div>
          </div>
        </div>
        <div class="report-content">
    `;
  }
  return `
    <div class="in-app-report-header">
      <h2 class="in-app-report-title">${title}</h2>
      <div class="in-app-report-meta">
        <span>Generated: ${formatDate(new Date())} at ${formatTime(new Date())}</span>
        <span>By: ${currentUser?.email || currentUser?.role || 'System'}</span>
      </div>
    </div>
  `;
};

// -------------- FIXED Report Helpers with consistent date filtering --------------
const withRange = (defaultFrom, defaultTo) => {
  if (currentReportRange?.from && currentReportRange?.to) {
    const fromDate = new Date(currentReportRange.from);
    const toDate = new Date(currentReportRange.to);
    return { 
      from: startOfDay(fromDate), 
      to: endOfDay(toDate) 
    };
  }
  return { from: defaultFrom, to: defaultTo };
};

// -------------- FIXED Reports: Sales with proper date filtering --------------
const generateDailySalesReport = async (forExport=true) => {
  const today = new Date();
  const { from, to } = withRange(startOfDay(today), endOfDay(today));
  
  // Use consistent date filtering across all reports
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  let html = generateProfessionalReportHeader('Daily Sales Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const sum = sales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Date</div><div class="summary-value">${formatDate(from)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value">${sales.length}</div></div>
        <div class="summary-item"><div class="summary-label">Total Revenue</div><div class="summary-value">${formatCurrency(sum)}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>MRN</th><th>Patient Name</th><th>Amount</th><th>Time</th><th>Sold By</th></tr></thead>
      <tbody>
  `;
  for (const sale of sales) {
    const patient = await localDB.patients.where('mrn').equals(sale.patientMrn).first();
    html += `
      <tr>
        <td style="font-weight:900; color:#5D5CDE">${sale.patientMrn}</td>
        <td>${patient?.name || 'Unknown'}</td>
        <td style="font-weight:900; color:#10B981">${formatCurrency(sale.totalPaid)}</td>
        <td>${formatTime(sale.timestamp)}</td>
        <td>${sale.createdByEmail || sale.createdBy}</td>
      </tr>
    `;
  }
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateWeeklySalesReport = async (forExport=true) => {
  const today = new Date();
  const weekStart = startOfDay(new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6));
  const { from, to } = withRange(weekStart, endOfDay(today));
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  let html = generateProfessionalReportHeader('Weekly Sales Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const sum = sales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value">${sales.length}</div></div>
        <div class="summary-item"><div class="summary-label">Total Revenue</div><div class="summary-value">${formatCurrency(sum)}</div></div>
      </div>
    </div>
  `;
  const dailyStats = {};
  sales.forEach(s => {
    const day = new Date(s.timestamp).toISOString().slice(0,10);
    dailyStats[day] ??= { count: 0, revenue: 0 };
    dailyStats[day].count++;
    dailyStats[day].revenue += Number(s.totalPaid || 0);
  });
  html += `<table class="${tableClass}"><thead><tr><th>Date</th><th>Sales Count</th><th>Revenue</th><th>Avg per Sale</th></tr></thead><tbody>`;
  Object.entries(dailyStats).sort(([a],[b]) => a.localeCompare(b)).forEach(([date, stats]) => {
    const avg = stats.count ? stats.revenue / stats.count : 0;
    html += `
      <tr>
        <td style="font-weight:900">${formatDate(date)}</td>
        <td style="text-align:center; color:#5D5CDE; font-weight:900">${stats.count}</td>
        <td style="font-weight:900; color:#10B981">${formatCurrency(stats.revenue)}</td>
        <td style="color:#6B7280">${formatCurrency(avg)}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateMonthlySalesReport = async (forExport=true) => {
  const today = new Date();
  const monthAgo = startOfDay(new Date(today.getFullYear(), today.getMonth(), 1));
  const { from, to } = withRange(monthAgo, endOfDay(today));
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  let html = generateProfessionalReportHeader('Monthly Sales Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const sum = sales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value">${sales.length}</div></div>
        <div class="summary-item"><div class="summary-label">Total Revenue</div><div class="summary-value">${formatCurrency(sum)}</div></div>
      </div>
    </div>
  `;
  const weekly = {};
  sales.forEach(s => {
    const d = new Date(s.timestamp);
    const key = `Week ${Math.ceil(d.getDate()/7)}`;
    weekly[key] ??= { count: 0, revenue: 0 };
    weekly[key].count++;
    weekly[key].revenue += Number(s.totalPaid || 0);
  });
  const weeks = Object.keys(weekly).sort();
  html += `<table class="${tableClass}"><thead><tr><th>Period</th><th>Sales Count</th><th>Revenue</th><th>Growth</th></tr></thead><tbody>`;
  weeks.forEach((w, i) => {
    const cur = weekly[w], prev = i>0 ? weekly[weeks[i-1]] : null;
    const growth = prev && prev.revenue ? ((cur.revenue - prev.revenue) / prev.revenue * 100) : 0;
    const growthStyle = growth >= 0 ? '#10B981' : '#EF4444';
    const arrow = growth >= 0 ? '‚Üó' : '‚Üò';
    html += `
      <tr>
        <td style="font-weight:900">${w}</td>
        <td style="text-align:center; color:#5D5CDE; font-weight:900">${cur.count}</td>
        <td style="font-weight:900; color:#10B981">${formatCurrency(cur.revenue)}</td>
        <td style="color:${growthStyle}; font-weight:900">${arrow} ${Math.abs(growth).toFixed(1)}%</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateYearlySalesReport = async (forExport=true) => {
  const today = new Date();
  const yearStart = startOfDay(new Date(today.getFullYear(), 0, 1));
  const { from, to } = withRange(yearStart, endOfDay(today));
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  let html = generateProfessionalReportHeader('Yearly Sales Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const sum = sales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);

  const monthly = Array.from({length:12}, () => ({ count:0, revenue:0 }));
  sales.forEach(s => {
    const d = new Date(s.timestamp);
    const idx = d.getMonth();
    monthly[idx].count++;
    monthly[idx].revenue += Number(s.totalPaid || 0);
  });

  const growths = monthly.map((m, i) => {
    if (i === 0) return null;
    const prev = monthly[i-1];
    if (prev.revenue === 0) return null;
    return ((m.revenue - prev.revenue) / prev.revenue) * 100;
  });

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Year</div><div class="summary-value">${from.getFullYear()}</div></div>
        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value">${sales.length}</div></div>
        <div class="summary-item"><div class="summary-label">Total Revenue</div><div class="summary-value">${formatCurrency(sum)}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Month</th><th>Sales Count</th><th>Revenue</th><th>Avg per Sale</th><th>Growth</th></tr></thead>
      <tbody>
  `;
  const monthNames = Array.from({length:12}, (_,i)=> new Date(2000,i,1).toLocaleString('en-ET',{month:'long'}));
  monthly.forEach((m, i) => {
    const avg = m.count ? m.revenue / m.count : 0;
    const g = growths[i];
    const isUp = g !== null && g >= 0;
    const arrow = g === null ? '--' : (isUp ? '‚Üó' : '‚Üò');
    const color = g === null ? '#6B7280' : (isUp ? '#10B981' : '#EF4444');
    const gText = g === null ? 'N/A' : `${Math.abs(g).toFixed(1)}%`;
    html += `
      <tr>
        <td style="font-weight:900">${monthNames[i]}</td>
        <td style="text-align:center; color:#5D5CDE; font-weight:900">${m.count}</td>
        <td style="font-weight:900; color:#10B981">${formatCurrency(m.revenue)}</td>
        <td style="color:#6B7280">${formatCurrency(avg)}</td>
        <td style="color:${color}; font-weight:900">${arrow} ${gText}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

// -------------- FIXED Reports: Inventory & Financials with consistent date filtering --------------
const generateInventoryReport = async (forExport=true) => {
  const inv = await localDB.inventory.toArray();
  let html = generateProfessionalReportHeader('Current Inventory Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const totalItems = inv.length;
  const lowStock = inv.filter(i => Number(i.totalStock) < 5).length;
  const expired = inv.filter(i => new Date(i.expiryDate) < new Date()).length;

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Total Items</div><div class="summary-value">${totalItems}</div></div>
        <div class="summary-item"><div class="summary-label">Low Stock Items</div><div class="summary-value" style="color:#F59E0B">${lowStock}</div></div>
        <div class="summary-item"><div class="summary-label">Expired Items</div><div class="summary-value" style="color:#EF4444">${expired}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Drug Name</th><th>Dose</th><th>Stock</th><th>Supplier</th><th>Expiry Date</th><th>Status</th></tr></thead>
      <tbody>
  `;
  inv.forEach(item => {
    const status = getInventoryStatus(item);
    const color = status.status === 'normal' ? '#10B981' : (status.status === 'low-stock' ? '#F59E0B' : '#EF4444');
    html += `
      <tr>
        <td style="font-weight:900">${item.drugName}</td>
        <td>${item.dose}</td>
        <td style="text-align:center; font-weight:900">${item.totalStock} ${item.unit}</td>
        <td>${item.supplier}</td>
        <td>${formatDate(item.expiryDate)}</td>
        <td style="color:${color}; font-weight:900">${status.text}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateExpiredDrugsReport = async (forExport=true) => {
  const inv = await localDB.inventory.toArray();
  const list = inv.filter(i => ['expired','expiring'].includes(getInventoryStatus(i).status));
  let html = generateProfessionalReportHeader('Expired & Expiring Drugs Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Total Expired/Expiring</div><div class="summary-value" style="color:#EF4444">${list.length}</div></div>
        <div class="summary-item"><div class="summary-label">Report Date</div><div class="summary-value">${formatDate(new Date())}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Drug Name</th><th>Dose</th><th>Stock</th><th>Expiry Date</th><th>Days to Expiry</th><th>Action Required</th></tr></thead>
      <tbody>
  `;
  list.forEach(item => {
    const today = new Date();
    const expiry = new Date(item.expiryDate);
    const days = Math.ceil((expiry - today)/86400000);
    const expired = days < 0;
    const color = expired ? '#EF4444' : '#F59E0B';
    const action = expired ? 'Remove immediately' : 'Monitor closely';
    html += `
      <tr>
        <td style="font-weight:900">${item.drugName}</td>
        <td>${item.dose}</td>
        <td style="text-align:center; font-weight:900">${item.totalStock} ${item.unit}</td>
        <td style="color:${color}; font-weight:900">${formatDate(item.expiryDate)}</td>
        <td style="color:${color}; font-weight:900; text-align:center">${expired ? 'EXPIRED' : days + ' days'}</td>
        <td style="color:${color}; font-weight:900">${action}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateLowStockReport = async (forExport=true) => {
  const inv = await localDB.inventory.toArray();
  const list = inv.filter(i => Number(i.totalStock) < 5);
  let html = generateProfessionalReportHeader('Low Stock Items Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Low Stock Items</div><div class="summary-value" style="color:#F59E0B">${list.length}</div></div>
        <div class="summary-item"><div class="summary-label">Threshold</div><div class="summary-value">&lt; 5 units</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Drug Name</th><th>Dose</th><th>Unit</th><th>Stock</th><th>Supplier</th><th>Expiry</th></tr></thead><tbody>
  `;
  list.forEach(item => {
    html += `
      <tr>
        <td style="font-weight:900">${item.drugName}</td>
        <td>${item.dose}</td>
        <td>${item.unit}</td>
        <td style="font-weight:900; color:#F59E0B">${item.totalStock}</td>
        <td>${item.supplier || '-'}</td>
        <td>${formatDate(item.expiryDate)}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateInventoryMovementReport = async (forExport=true) => {
  const defaultFrom = startOfDay(new Date(Date.now() - 30*86400000));
  const { from, to } = withRange(defaultFrom, endOfDay(new Date()));
  
  const purchases = await localDB.purchases.filter(purchase => {
    const purchaseDate = new Date(purchase.timestamp);
    return purchaseDate >= from && purchaseDate <= to;
  }).toArray();
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();

  const movement = {};
  const keyOf = (n,d,u) => `${n}|${d}|${u}`;
  purchases.forEach(p => {
    const k = keyOf(p.drugName, p.dose, p.unit);
    movement[k] ??= { name:p.drugName, dose:p.dose, unit:p.unit, in:0, out:0 };
    movement[k].in += Number(p.quantity)||0;
  });
  sales.forEach(s => {
    (s.drugs||[]).forEach(d => {
      const k = keyOf(d.name, d.dose, d.unit);
      movement[k] ??= { name:d.name, dose:d.dose, unit:d.unit, in:0, out:0 };
      movement[k].out += Number(d.quantity)||0;
    });
  });
  const rows = Object.values(movement).sort((a,b)=> (b.in - b.out) - (a.in - a.out));

  let html = generateProfessionalReportHeader('Inventory Movement Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const totalIn = rows.reduce((s,r)=>s+r.in,0);
  const totalOut = rows.reduce((s,r)=>s+r.out,0);
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Incoming</div><div class="summary-value" style="color:#10B981">${totalIn}</div></div>
        <div class="summary-item"><div class="summary-label">Total Outgoing</div><div class="summary-value" style="color:#EF4444">${totalOut}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Drug</th><th>Dose</th><th>Unit</th><th>Incoming</th><th>Outgoing</th><th>Net</th></tr></thead>
      <tbody>
  `;
  rows.forEach(r => {
    const net = r.in - r.out;
    const color = net >= 0 ? '#10B981' : '#EF4444';
    html += `
      <tr>
        <td style="font-weight:900">${r.name}</td>
        <td>${r.dose}</td>
        <td>${r.unit}</td>
        <td style="text-align:center; color:#10B981; font-weight:900">${r.in}</td>
        <td style="text-align:center; color:#EF4444; font-weight:900">${r.out}</td>
        <td style="text-align:center; color:${color}; font-weight:900">${net}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateProfitLossReport = async (forExport=true) => {
  const sales = await localDB.sales.toArray();
  const expenses = await localDB.expenses.toArray();
  const revenue = sales.reduce((s, x) => s + Number(x.totalPaid || 0), 0);
  const totalExp = expenses.reduce((s, x) => s + Number(x.amount || 0), 0);
  const net = revenue - totalExp;

  let html = generateProfessionalReportHeader('Profit & Loss Report', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Financial Summary</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 16px; margin-bottom: 14px;">
        <div style="background:linear-gradient(135deg,#10B981 0%,#059669 100%); color:#fff; padding:18px; border-radius:10px; text-align:center;">
          <h4 style="margin:0 0 6px; font-size:13px; opacity:.92;">Total Revenue</h4>
          <p style="margin:0; font-size:22px; font-weight:900;">${formatCurrency(revenue)}</p>
        </div>
        <div style="background:linear-gradient(135deg,#EF4444 0%,#DC2626 100%); color:#fff; padding:18px; border-radius:10px; text-align:center;">
          <h4 style="margin:0 0 6px; font-size:13px; opacity:.92;">Total Expenses</h4>
          <p style="margin:0; font-size:22px; font-weight:900;">${formatCurrency(totalExp)}</p>
        </div>
        <div style="background:linear-gradient(135deg,#5D5CDE 0%,#4F46E5 100%); color:#fff; padding:18px; border-radius:10px; text-align:center;">
          <h4 style="margin:0 0 6px; font-size:13px; opacity:.92;">Net Profit</h4>
          <p style="margin:0; font-size:22px; font-weight:900;">${formatCurrency(net)}</p>
        </div>
      </div>
    </div>

    <h3 style="color:#1F2A7A; margin: 18px 0 10px; font-weight:900;">Expense Breakdown</h3>
    <table class="${tableClass}">
      <thead><tr><th>Expense Type</th><th>Amount</th><th>Percentage</th><th>Impact</th></tr></thead>
      <tbody>
  `;
  const byType = {};
  expenses.forEach(e => { byType[e.type] = (byType[e.type] || 0) + Number(e.amount || 0); });
  Object.entries(byType).forEach(([type, amount]) => {
    const pct = totalExp ? (amount / totalExp) * 100 : 0;
    const impactColor = pct > 40 ? '#EF4444' : pct > 20 ? '#F59E0B' : '#10B981';
    const impact = pct > 40 ? 'High' : pct > 20 ? 'Medium' : 'Low';
    html += `
      <tr>
        <td style="font-weight:900">${type}</td>
        <td style="font-weight:900; color:#EF4444">${formatCurrency(amount)}</td>
        <td style="text-align:center; font-weight:900">${pct.toFixed(1)}%</td>
        <td style="color:${impactColor}; font-weight:900">${impact}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateExpenseBreakdownReport = async (forExport=true) => {
  const defaultFrom = startOfDay(new Date(Date.now() - 30*86400000));
  const { from, to } = withRange(defaultFrom, endOfDay(new Date()));
  
  const expenses = await localDB.expenses.filter(expense => {
    const expenseDate = new Date(expense.timestamp);
    return expenseDate >= from && expenseDate <= to;
  }).toArray();
  
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  let html = generateProfessionalReportHeader('Expense Breakdown (Last 30 Days)', forExport);
  const totalExp = expenses.reduce((s,e)=> s + Number(e.amount||0), 0);
  const byType = {};
  expenses.forEach(e => { byType[e.type] = (byType[e.type] || 0) + Number(e.amount||0); });

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Expenses</div><div class="summary-value" style="color:#EF4444">${formatCurrency(totalExp)}</div></div>
        <div class="summary-item"><div class="summary-label">Categories</div><div class="summary-value">${Object.keys(byType).length}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Type</th><th>Amount</th><th>Share</th></tr></thead><tbody>
  `;
  Object.entries(byType).sort((a,b)=> b[1]-a[1]).forEach(([type, amount])=>{
    const pct = totalExp ? (amount/totalExp)*100 : 0;
    html += `
      <tr>
        <td style="font-weight:900">${type}</td>
        <td style="font-weight:900; color:#EF4444">${formatCurrency(amount)}</td>
        <td style="text-align:center; font-weight:900">${pct.toFixed(1)}%</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateWorkerPerformanceReport = async (forExport=true) => {
  const defaultFrom = startOfDay(new Date(Date.now() - 30*86400000));
  const { from, to } = withRange(defaultFrom, endOfDay(new Date()));
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  const byUser = {};
  sales.forEach(s => {
    const key = s.createdByEmail || s.createdBy || 'Unknown';
    byUser[key] ??= { count:0, revenue:0 };
    byUser[key].count++;
    byUser[key].revenue += Number(s.totalPaid||0);
  });

  let html = generateProfessionalReportHeader('Worker Performance (Last 30 Days)', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  const rows = Object.entries(byUser).map(([user, stats]) => ({ user, ...stats }))
    .sort((a,b)=> b.revenue - a.revenue);
  const totalSales = rows.reduce((s,r)=> s + r.count, 0);
  const totalRevenue = rows.reduce((s,r)=> s + r.revenue, 0);

  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value">${totalSales}</div></div>
        <div class="summary-item"><div class="summary-label">Total Revenue</div><div class="summary-value">${formatCurrency(totalRevenue)}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Worker</th><th>Sales Count</th><th>Revenue</th><th>Avg per Sale</th></tr></thead><tbody>
  `;
  rows.forEach(r => {
    const avg = r.count ? r.revenue / r.count : 0;
    html += `
      <tr>
        <td style="font-weight:900">${r.user}</td>
        <td style="text-align:center; color:#5D5CDE; font-weight:900">${r.count}</td>
        <td style="color:#10B981; font-weight:900">${formatCurrency(r.revenue)}</td>
        <td style="color:#6B7280">${formatCurrency(avg)}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateDrugWiseSalesReport = async (forExport=true) => {
  const defaultFrom = startOfDay(new Date(Date.now() - 30*86400000));
  const { from, to } = withRange(defaultFrom, endOfDay(new Date()));
  
  const sales = await localDB.sales.filter(sale => {
    const saleDate = new Date(sale.timestamp);
    return saleDate >= from && saleDate <= to;
  }).toArray();
  
  const map = {};
  const keyOf = (d) => `${d.name}|${d.dose}|${d.unit}`;
  for (const s of sales) {
    for (const d of (s.drugs || [])) {
      const k = keyOf(d);
      map[k] ??= { name:d.name, dose:d.dose, unit:d.unit, quantity:0, revenue:0 };
      map[k].quantity += Number(d.quantity)||0;
      const price = await calculateDrugSellingPrice(d.name, d.dose, d.unit);
      map[k].revenue += Number(d.quantity) * price;
    }
  }
  const rows = Object.values(map).sort((a,b)=> b.revenue - a.revenue);
  const totalQty = rows.reduce((s,r)=> s + r.quantity, 0);
  const totalRev = rows.reduce((s,r)=> s + r.revenue, 0);

  let html = generateProfessionalReportHeader('Drug-wise Sales (Last 30 Days)', forExport);
  const tableClass = forExport ? 'modern-table' : 'compact-table';
  html += `
    <div class="modern-report-summary">
      <h3 class="summary-title">Summary</h3>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Period</div><div class="summary-value">${formatDate(from)} - ${formatDate(to)}</div></div>
        <div class="summary-item"><div class="summary-label">Total Quantity</div><div class="summary-value">${totalQty}</div></div>
        <div class="summary-item"><div class="summary-label">Estimated Revenue</div><div class="summary-value">${formatCurrency(totalRev)}</div></div>
      </div>
    </div>
    <table class="${tableClass}">
      <thead><tr><th>Drug</th><th>Dose</th><th>Unit</th><th>Quantity</th><th>Estimated Revenue</th></tr></thead><tbody>
  `;
  rows.forEach(r => {
    html += `
      <tr>
        <td style="font-weight:900">${r.name}</td>
        <td>${r.dose}</td>
        <td>${r.unit}</td>
        <td style="text-align:center; color:#5D5CDE; font-weight:900">${r.quantity}</td>
        <td style="color:#10B981; font-weight:900">${formatCurrency(r.revenue)}</td>
      </tr>
    `;
  });
  html += `</tbody></table>${forExport ? '</div></div>' : ''}`;
  return html;
};

const generateReport = async (type) => {
  const reportDisplay = el('reportDisplay');
  const reportTitle = el('reportTitle');
  const reportContent = el('reportContent');
  try {
    let html = '';
    let title = '';
    currentReportKey = type;
    switch (type) {
      case 'daily-sales': title = 'Daily Sales Report'; html = await generateDailySalesReport(false); break;
      case 'weekly-sales': title = 'Weekly Sales Report'; html = await generateWeeklySalesReport(false); break;
      case 'monthly-sales': title = 'Monthly Sales Report'; html = await generateMonthlySalesReport(false); break;
      case 'yearly-sales': title = 'Yearly Sales Report'; html = await generateYearlySalesReport(false); break;
      case 'current-inventory': title = 'Current Inventory Report'; html = await generateInventoryReport(false); break;
      case 'expired-drugs': title = 'Expired & Expiring Drugs Report'; html = await generateExpiredDrugsReport(false); break;
      case 'low-stock': title = 'Low Stock Items Report'; html = await generateLowStockReport(false); break;
      case 'inventory-movement': title = 'Inventory Movement Report'; html = await generateInventoryMovementReport(false); break;
      case 'profit-loss': title = 'Profit & Loss Report'; html = await generateProfitLossReport(false); break;
      case 'expense-breakdown': title = 'Expense Breakdown (Last 30 Days)'; html = await generateExpenseBreakdownReport(false); break;
      case 'worker-performance': title = 'Worker Performance (Last 30 Days)'; html = await generateWorkerPerformanceReport(false); break;
      case 'drug-wise-sales': title = 'Drug-wise Sales (Last 30 Days)'; html = await generateDrugWiseSalesReport(false); break;
      default: title = 'Report'; html = '<p>Report type not implemented yet.</p>';
    }
    reportTitle.textContent = title;
    reportContent.innerHTML = html;
    reportDisplay.style.display = 'block';
    window.currentReportData = { title, content: html, key: type };
  } catch (e) {
    console.error('generateReport', e);
    showAlert('Error', 'Failed to generate report. Please try again.');
  }
};

const exportToPDF = () => {
  if (!window.currentReportData) return showAlert('Error', 'No report data available for export.');
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const margin = 28;
    // Header
    doc.setFillColor(93,92,222); doc.circle(margin+20, margin+20, 14, 'F');
    doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text('S', margin+20, margin+25, { align: 'center' });
    doc.setTextColor(93,92,222); doc.setFontSize(14);
    doc.text('Sheikh Bakri Saphalo Medium Clinic', margin+50, margin+12);
    doc.setFontSize(10); doc.text('Professional Pharmacy Management System', margin+50, margin+26);

    doc.setTextColor(55,65,81); doc.setFontSize(16); doc.text(window.currentReportData.title, margin, margin+52);
    doc.setFontSize(10);
    doc.text(`Generated: ${formatDate(new Date())} at ${formatTime(new Date())}`, margin, margin+68);
    doc.text(`Generated by: ${currentUser?.email || currentUser?.role || 'System'}`, margin, margin+82);

    doc.setDrawColor(93,92,222); doc.setLineWidth(2); doc.line(margin, margin+94, 595 - margin, margin+94);

    // Simple table export
    const content = el('reportContent');
    const tables = content.querySelectorAll('table');
    let y = margin + 110;
    tables.forEach(table => {
      const rows = table.querySelectorAll('tr');
      rows.forEach((row, idx) => {
        const cells = row.querySelectorAll('th,td');
        let x = margin;
        if (idx === 0) {
          doc.setFillColor(93,92,222);
          doc.rect(x, y - 14, 595 - margin*2, 18, 'F');
          doc.setTextColor(255,255,255);
        } else {
          doc.setTextColor(55,65,81);
        }
        cells.forEach((cell, ci) => {
          const text = (cell.textContent || '').trim();
          const maxChars = 30;
          doc.setFontSize(9);
          doc.text(text.substring(0, maxChars), x + 6, y);
          x += Math.max(90, (595 - margin*2) / Math.min(6, cells.length));
        });
        y += 18;
        if (y > 800) { doc.addPage(); y = margin + 30; }
      });
      y += 10;
    });
    const safeName = `${window.currentReportData.title.replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_')}.pdf`;
    doc.save(safeName);
    showToast('PDF exported successfully', 'success');
  } catch (e) {
    console.error('export pdf', e);
    showAlert('Error', 'Failed to export PDF. Please try again.');
  }
};

const exportToCSV = () => {
  if (!window.currentReportData) return showAlert('Error', 'No report data available for export.');
  try {
    const content = el('reportContent');
    const tables = content.querySelectorAll('table');
    let csv = 'Sheikh Bakri Saphalo Medium Clinic\nProfessional Pharmacy Management System\n\n';
    csv += `${window.currentReportData.title}\n`;
    csv += `Generated: ${formatDate(new Date())} at ${formatTime(new Date())}\n`;
    csv += `Generated by: ${currentUser?.email || currentUser?.role || 'System'}\n\n`;
    tables.forEach(table => {
      const rows = table.querySelectorAll('tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('th,td');
        const rowData = Array.from(cells).map(c => `"${(c.textContent || '').trim().replace(/"/g,'""')}"`);
        csv += rowData.join(',') + '\n';
      });
      csv += '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const safeName = `${window.currentReportData.title.replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_')}.csv`;
    a.download = safeName;
    a.click();
    showToast('CSV exported successfully', 'success');
  } catch (e) {
    console.error('export csv', e);
    showAlert('Error', 'Failed to export CSV. Please try again.');
  }
};

// -------------- Sales table with FIXED date filtering --------------
const loadSalesTable = async () => {
  try {
    const dateFilter = el('salesDateFilter')?.value || '';
    const queryText = el('salesSearchFilter')?.value?.toLowerCase()?.trim() || '';
    let sales = await localDB.sales.orderBy('timestamp').reverse().toArray();

    if (dateFilter) {
      const from = startOfDay(new Date(dateFilter));
      const to = endOfDay(new Date(dateFilter));
      sales = sales.filter(s => {
        const saleDate = new Date(s.timestamp);
        return saleDate >= from && saleDate <= to;
      });
    }
    if (queryText) {
      sales = await Promise.all(sales.map(async s => {
        const patient = await localDB.patients.where('mrn').equals(s.patientMrn).first();
        const matches = s.patientMrn?.toString()?.includes(queryText) || patient?.name?.toLowerCase()?.includes(queryText);
        return matches ? s : null;
      }));
      sales = sales.filter(Boolean);
    }

    const tbody = el('salesTableBody');
    tbody.innerHTML = '';
    if (!sales.length) {
      el('salesEmptyState')?.classList.remove('hidden');
      return;
    } else {
      el('salesEmptyState')?.classList.add('hidden');
    }

    for (const sale of sales) {
      const patient = await localDB.patients.where('mrn').equals(sale.patientMrn).first();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${sale.patientMrn}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${patient?.name || 'Unknown'}</td>
        <td class="px-6 py-4 text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${Array.isArray(sale.drugs) ? sale.drugs.map(d => `${d.name} (${d.quantity} ${d.unit})`).join(', ') : 'N/A'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-accent">${formatCurrency(sale.totalPaid)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${sale.createdByEmail || sale.createdBy}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatDate(sale.timestamp)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold">
          <button class="text-primary hover:text-secondary" data-action="view" data-id="${sale.id}">View</button>
          ${currentUser?.role === 'admin' ? `<button class="text-danger hover:text-red-600 ml-2" data-action="delete" data-id="${sale.id}">Delete</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) { console.error('loadSales', e); }
};
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-action][data-id]');
  if (!btn) return;
  const id = Number(btn.getAttribute('data-id'));
  const action = btn.getAttribute('data-action');
  if (action === 'view') {
    const sale = await localDB.sales.get(id);
    if (!sale) return;
    showReceiptPreview(sale);
  } else if (action === 'delete') {
    showConfirm('Delete Sale', 'Are you sure you want to delete this sale?', async () => {
      try {
        const sale = await localDB.sales.get(id);
        await localDB.sales.delete(id);
        await queueSync('sales', 'delete', { remoteId: sale?.remoteId, id: sale?.id, updatedAt: nowIso() });
        await logActivity('delete', 'sales', `Deleted sale ID: ${id}`);
        await triggerDataSync(['sales', 'dashboard']);
        showToast('Sale deleted', 'success');
      } catch { showAlert('Error', 'Failed to delete sale.'); }
    });
  }
});

// -------------- Drug row --------------
const addDrugRow = () => {
  const container = el('drugsContainer');
  const row = document.createElement('div');
  row.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg drug-row';
  row.innerHTML = `
    <div class="drug-selector">
      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">Drug Name</label>
      <input type="text" name="drugName" required class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
      <div class="drug-dropdown"></div>
    </div>
    <div>
      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">Dose</label>
      <input type="text" name="drugDose" required readonly class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-600 dark:text-white" />
    </div>
    <div>
      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">Unit</label>
      <select name="drugUnit" required disabled class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-600 dark:border-gray-600 dark:text-white">
        <option value="">Select Unit</option>
        <option value="tab">Tablet</option>
        <option value="capsule">Capsule</option>
        <option value="strip">Strip</option>
        <option value="bottle">Bottle</option>
        <option value="vial">Vial</option>
        <option value="ampul">Ampul</option>
        <option value="tube">Tube</option>
        <option value="each">Each</option>
        <option value="pack">Pack</option>
        <option value="box">Box</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">Quantity</label>
      <input type="number" name="drugQuantity" required min="0" step="0.1" class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
      <div class="drug-price-display text-xs text-gray-700 dark:text-gray-200 mt-1 font-semibold"></div>
    </div>
    <div class="flex items-end">
      <button type="button" class="bg-danger text-white px-4 py-2 rounded-lg font-extrabold hover:bg-red-600 transition-colors duration-200 w-full" data-remove-drug>Remove</button>
    </div>
  `;
  container.appendChild(row);
  const nameInput = row.querySelector('[name="drugName"]');
  const doseInput = row.querySelector('[name="drugDose"]');
  const unitInput = row.querySelector('[name="drugUnit"]');
  const qtyInput = row.querySelector('[name="drugQuantity"]');
  setupDrugDropdown(nameInput, doseInput, unitInput, qtyInput);
};
document.addEventListener('click', (e) => {
  if (e.target.matches('[data-remove-drug]')) {
    e.target.closest('.drug-row')?.remove();
    calculateSaleTotal();
  }
});

const saveSale = async (saleData) => {
  try {
    for (const d of saleData.drugs) {
      const v = await validateInventoryAvailability(d.name, d.dose, d.unit, d.quantity);
      if (!v.valid) { showAlert('Validation Error', v.message); return false; }
    }
    const existing = await localDB.patients.where('mrn').equals(saleData.mrn).first();
    const patientPayload = {
      mrn: saleData.mrn, name: saleData.patientName, age: saleData.patientAge, sex: saleData.patientSex,
      address: saleData.patientAddress, diagnosis: saleData.diagnosis, lastVisit: new Date(), updatedAt: nowIso()
    };
    if (!existing) {
      const unique = await validateMRNUniqueness(saleData.mrn);
      if (!unique) { showAlert('Error', 'MRN already exists. Please use a different MRN.'); return false; }
      const pid = await localDB.patients.add(patientPayload);
      await queueSync('patients', 'upsert', { ...patientPayload, localTableId: pid });
    } else {
      await localDB.patients.update(existing.id, { lastVisit: new Date(), diagnosis: saleData.diagnosis, updatedAt: nowIso() });
      await queueSync('patients', 'upsert', { ...existing, lastVisit: new Date(), diagnosis: saleData.diagnosis, updatedAt: nowIso(), localTableId: existing.id });
    }
    const sale = { patientMrn: saleData.mrn, totalPaid: saleData.totalPaid, createdBy: currentUser.role, createdByEmail: currentUserEmail, drugs: saleData.drugs, timestamp: new Date(), updatedAt: nowIso() };
    const saleId = await localDB.sales.add(sale);
    await queueSync('sales', 'upsert', { ...sale, localTableId: saleId });

    await updateInventoryFromSale(saleData.drugs);
    await logActivity('create', 'sales', `Sale for patient ${saleData.patientName} (MRN: ${saleData.mrn})`);
    scheduleSyncSoon('new-sale');
    return { success: true, id: saleId, record: sale };
  } catch (e) {
    console.error('saveSale', e);
    showAlert('Error', 'Failed to save sale. Please try again.');
    return { success: false };
  }
};

// -------------- Purchases with FIXED inventory updates --------------
const loadPurchasesTable = async () => {
  try {
    const purchases = await localDB.purchases.orderBy('timestamp').reverse().toArray();
    const tbody = el('purchasesTableBody'); tbody.innerHTML = '';
    if (!purchases.length) {
      el('purchasesEmptyState')?.classList.remove('hidden');
      return;
    } else el('purchasesEmptyState')?.classList.add('hidden');
    for (const p of purchases) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${p.drugName}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${p.dose}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${p.quantity} ${p.unit}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatCurrency(p.unitPrice)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-accent">${formatCurrency(Number(p.quantity)*Number(p.unitPrice))}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${p.supplier}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatDate(p.expiryDate)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold">
          ${currentUser?.role === 'admin' ? `
            <button class="text-primary hover:text-secondary mr-2" data-edit-purchase="${p.id}">Edit</button>
            <button class="text-danger hover:text-red-600" data-delete-purchase="${p.id}">Delete</button>
          ` : 'Read Only'}
        </td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) { console.error('loadPurchases', e); }
};

const editPurchase = async (id) => {
  try {
    const p = await localDB.purchases.get(id);
    if (!p) return showAlert('Error', 'Purchase not found.');
    editingPurchaseId = id;
    el('purchaseModalTitle').textContent = 'Edit Purchase';
    el('purchaseSubmitBtn').textContent = 'Update Purchase';
    el('purchaseId').value = id;
    el('purchaseDrugName').value = p.drugName;
    el('purchaseDose').value = p.dose;
    el('purchaseUnit').value = p.unit;
    el('purchaseQuantity').value = p.quantity;
    el('purchaseUnitPrice').value = p.unitPrice;
    el('purchaseTotalPrice').value = (Number(p.quantity)*Number(p.unitPrice)).toFixed(2);
    el('purchaseSupplier').value = p.supplier;
    el('purchaseExpiryDate').value = (p.expiryDate || '').slice(0,10);
    openModal('addPurchaseModal');
  } catch (e) {
    console.error('editPurchase', e);
    showAlert('Error', 'Failed to load purchase data.');
  }
};

const savePurchase = async (data) => {
  try {
    if (editingPurchaseId) {
      // Handle purchase edit with proper inventory updates
      const oldP = await localDB.purchases.get(editingPurchaseId);
      if (!oldP) {
        showAlert('Error', 'Original purchase not found.');
        return false;
      }
      
      const updated = { 
        ...data, 
        createdBy: oldP.createdBy, 
        timestamp: oldP.timestamp, 
        updatedAt: nowIso() 
      };
      
      // Update purchase record
      await localDB.purchases.update(editingPurchaseId, updated);
      await queueSync('purchases', 'upsert', { 
        ...oldP, 
        ...updated, 
        localTableId: editingPurchaseId 
      });
      
      // Update inventory (this will revert old and add new)
      await updateInventoryFromPurchase(updated, true, oldP);
      await logActivity('update', 'purchases', `Updated purchase of ${updated.drugName} from ${updated.supplier}`);
      
      editingPurchaseId = null;
      el('purchaseModalTitle').textContent = 'New Purchase';
      el('purchaseSubmitBtn').textContent = 'Add Purchase';
      
      showToast('Purchase updated successfully', 'success');
    } else {
      // Handle new purchase
      const p = { ...data, createdBy: currentUser.role, timestamp: new Date(), updatedAt: nowIso() };
      const pid = await localDB.purchases.add(p);
      await queueSync('purchases', 'upsert', { ...p, localTableId: pid });
      await updateInventoryFromPurchase(p);
      await logActivity('create', 'purchases', `Purchase of ${p.drugName} from ${p.supplier}`);
      
      showToast('Purchase added successfully', 'success');
    }
    
    scheduleSyncSoon('purchase-change');
    return true;
  } catch (e) {
    console.error('savePurchase', e);
    showAlert('Error', 'Failed to save purchase. Please try again.');
    return false;
  }
};

document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('[data-edit-purchase]');
  if (editBtn) return editPurchase(Number(editBtn.getAttribute('data-edit-purchase')));
  const delBtn = e.target.closest('[data-delete-purchase]');
  if (delBtn) {
    const id = Number(delBtn.getAttribute('data-delete-purchase'));
    showConfirm('Delete Purchase', 'Are you sure you want to delete this purchase? This will also update inventory levels.', async () => {
      try {
        const p = await localDB.purchases.get(id);
        if (p) {
          // Revert inventory before deleting purchase
          await revertInventoryFromPurchase(p);
        }
        await localDB.purchases.delete(id);
        await queueSync('purchases', 'delete', { remoteId: p?.remoteId, id: p?.id, updatedAt: nowIso() });
        await logActivity('delete', 'purchases', `Deleted purchase ID: ${id} - ${p?.drugName || 'Unknown'}`);
        await triggerDataSync(['purchases', 'inventory', 'dashboard']);
        showToast('Purchase deleted and inventory updated', 'success');
        scheduleSyncSoon('purchase-delete');
      } catch(err) { 
        console.error('Delete purchase error:', err);
        showAlert('Error', 'Failed to delete purchase. Please try again.'); 
      }
    });
  }
});

// -------------- Inventory table --------------
const loadInventoryTable = async () => {
  try {
    const search = el('inventorySearchFilter')?.value?.toLowerCase() || '';
    const statusFilter = el('inventoryStatusFilter')?.value || '';
    const supplierFilter = el('inventorySupplierFilter')?.value?.toLowerCase() || '';
    let list = await localDB.inventory.toArray();
    list = list.filter(i =>
      (!search || (i.drugName?.toLowerCase().includes(search) || i.dose?.toLowerCase().includes(search))) &&
      (!supplierFilter || (i.supplier?.toLowerCase().includes(supplierFilter)))
    );
    const tbody = el('inventoryTableBody'); tbody.innerHTML = '';
    if (!list.length) {
      el('inventoryEmptyState')?.classList.remove('hidden');
      return;
    } else el('inventoryEmptyState')?.classList.add('hidden');

    for (const item of list) {
      const st = getInventoryStatus(item);
      if (statusFilter && st.status !== statusFilter) continue;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${item.drugName}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${item.dose}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${item.unit}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${item.totalStock}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${item.supplier}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatDate(item.expiryDate)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold ${st.class}">${st.text}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) { console.error('loadInventory', e); }
};

    // -------------- Expenses --------------
const loadExpensesTable = async () => {
  try {
    const expenses = await localDB.expenses.orderBy('timestamp').reverse().toArray();
    const tbody = el('expensesTableBody'); tbody.innerHTML = '';
    if (!expenses.length) {
      el('expensesEmptyState')?.classList.remove('hidden');
      return;
    } else el('expensesEmptyState')?.classList.add('hidden');
    for (const exp of expenses) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${exp.type}</td>
        <td class="px-6 py-4 text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${exp.description}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-danger">${formatCurrency(exp.amount)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${exp.createdBy}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatDate(exp.timestamp)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold">
          <button class="text-danger hover:text-red-600" data-delete-expense="${exp.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) { console.error('loadExpenses', e); }
};
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-delete-expense]');
  if (!btn) return;
  const id = Number(btn.getAttribute('data-delete-expense'));
  showConfirm('Delete Expense', 'Are you sure you want to delete this expense?', async () => {
    try {
      const exp = await localDB.expenses.get(id);
      await localDB.expenses.delete(id);
      await queueSync('expenses', 'delete', { remoteId: exp?.remoteId, id: exp?.id, updatedAt: nowIso() });
      await logActivity('delete', 'expenses', `Deleted expense ID: ${id}`);
      await triggerDataSync(['expenses', 'dashboard']);
      showToast('Expense deleted', 'success');
      scheduleSyncSoon('expense-delete');
    } catch { showAlert('Error', 'Failed to delete expense.'); }
  });
});

const saveExpense = async (data) => {
  try {
    const exp = { ...data, createdBy: currentUser.role, timestamp: new Date(), updatedAt: nowIso() };
    const id = await localDB.expenses.add(exp);
    await queueSync('expenses', 'upsert', { ...exp, localTableId: id });
    await logActivity('create', 'expenses', `Expense: ${exp.type} - ${formatCurrency(exp.amount)}`);
    await triggerDataSync(['dashboard']);
    scheduleSyncSoon('expense-add');
    return true;
  } catch (e) {
    console.error('saveExpense', e);
    showAlert('Error', 'Failed to save expense. Please try again.');
    return false;
  }
};

// -------------- Logs --------------
const loadLogsTable = async () => {
  try {
    const userFilter = el('logsUserFilter')?.value || '';
    const actionFilter = el('logsActionFilter')?.value || '';
    const dateFilter = el('logsDateFilter')?.value || '';
    let logs = await localDB.activityLogs.orderBy('timestamp').reverse().toArray();
    if (userFilter) logs = logs.filter(l => (userFilter.toLowerCase() === (currentUser?.role||'').toLowerCase()));
    if (actionFilter) logs = logs.filter(l => l.action === actionFilter);
    if (dateFilter) {
      const from = startOfDay(new Date(dateFilter));
      const to = endOfDay(new Date(dateFilter));
      logs = logs.filter(l => {
        const logDate = new Date(l.timestamp);
        return logDate >= from && logDate <= to;
      });
    }
    const tbody = el('logsTableBody'); tbody.innerHTML = '';
    if (!logs.length) {
      el('logsEmptyState')?.classList.remove('hidden');
      return;
    } else el('logsEmptyState')?.classList.add('hidden');
    for (const log of logs) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${currentUser?.email || currentUser?.role || 'System'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${log.action}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${log.module}</td>
        <td class="px-6 py-4 text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${log.details}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${formatDate(log.timestamp)} ${formatTime(log.timestamp)}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) { console.error('loadLogs', e); }
};

// -------------- Enhanced Backup & Restore --------------
const updateFolderStatus = () => {
  const status = el('folderStatus');
  const container = el('folderStatusContainer');
  if (selectedFolderHandle) {
    status.textContent = `Selected: ${selectedFolderHandle.name}`;
    status.className = 'text-sm text-green-700 dark:text-green-400';
    container.classList.add('selected');
  } else {
    status.textContent = 'No folder selected (will use downloads)';
    status.className = 'text-sm text-gray-800 dark:text-gray-100';
    container.classList.remove('selected');
  }
};
const chooseFolder = async () => {
  try {
    if ('showDirectoryPicker' in window) {
      selectedFolderHandle = await window.showDirectoryPicker();
      updateFolderStatus();
      return selectedFolderHandle;
    } else {
      showAlert('Not Supported', 'File System Access API not supported. Using fallback download/upload method.');
      return null;
    }
  } catch (e) {
    if (e.name !== 'AbortError') {
      console.error('chooseFolder', e);
      showAlert('Error', 'Failed to select folder. Please try again.');
    }
    return null;
  }
};
const generateBackupFilename = (role) => {
  const now = new Date();
  const date = now.toISOString().slice(0,10);
  const time = now.toTimeString().slice(0,8).replace(/:/g,'');
  return `backup-${role}-${date}-${time}.json`;
};
const collectAllAppData = async () => ({
  version: '3.0',
  timestamp: new Date().toISOString(),
  role: currentUser?.role || 'unknown',
  userEmail: currentUserEmail || '',
  clinic: 'Sheikh Bakri Saphalo Medium Clinic',
  users: await localDB.users.toArray(),
  patients: await localDB.patients.toArray(),
  drugs: await localDB.drugs.toArray(),
  suppliers: await localDB.suppliers.toArray(),
  sales: await localDB.sales.toArray(),
  salesDrugs: await localDB.salesDrugs.toArray(),
  purchases: await localDB.purchases.toArray(),
  expenses: await localDB.expenses.toArray(),
  activityLogs: await localDB.activityLogs.toArray(),
  inventory: await localDB.inventory.toArray(),
  backupHistory: await localDB.backupHistory.toArray(),
  syncMeta: await localDB.syncMeta.toArray()
});
const recordBackupHistory = async (fileName, type, size, status) => {
  await localDB.backupHistory.add({ date: new Date(), type, size: Math.round(size/1024) + ' KB', status, fileName });
};
const fallbackDownloadBackup = async (blob, fileName) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  await recordBackupHistory(fileName, 'Download', blob.size, 'Success');
  await logActivity('create', 'backup', `Download backup created: ${fileName}`);
  showToast(`Backup downloaded: ${fileName}`, 'success');
};
const backupData = async () => {
  try {
    const data = await collectAllAppData();
    const text = JSON.stringify(data, null, 2);
    const blob = new Blob([text], { type: 'application/json' });
    const fileName = generateBackupFilename(currentUser?.role || 'unknown');
    if (selectedFolderHandle && 'showDirectoryPicker' in window) {
      try {
        const fileHandle = await selectedFolderHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob); await writable.close();
        await recordBackupHistory(fileName, 'File System API', blob.size, 'Success');
        await logActivity('create', 'backup', `File System backup created: ${fileName}`);
        showToast(`Backup saved to ${selectedFolderHandle.name}/${fileName}`, 'success');
      } catch (fsErr) {
        console.error('FS API backup error', fsErr);
        await fallbackDownloadBackup(blob, fileName);
      }
    } else {
      await fallbackDownloadBackup(blob, fileName);
    }
    loadBackupHistory();
  } catch (e) {
    console.error('backup', e);
    showAlert('Error', 'Failed to create backup. Please try again.');
  }
};
const findMostRecentBackup = async () => {
  if (!selectedFolderHandle) return null;
  try {
    const role = currentUser?.role || '';
    let latest = null, lastTime = 0;
    for await (const [name, handle] of selectedFolderHandle.entries()) {
      if (handle.kind === 'file' && name.startsWith(`backup-${role}-`) && name.endsWith('.json')) {
        const file = await handle.getFile();
        if (file.lastModified > lastTime) { lastTime = file.lastModified; latest = handle; }
      }
    }
    return latest;
  } catch (e) { console.error('findMostRecentBackup', e); return null; }
};

const restoreLatestBackup = async () => {
  try {
    const latest = await findMostRecentBackup();
    if (!latest) {
      showAlert('No Backup Found', 'No backup files found in the selected folder.');
      return;
    }
    const file = await latest.getFile();
    await processBackupFile(file);
  } catch (e) {
    console.error('restoreLatestBackup', e);
    showAlert('Error', 'Failed to restore backup. Please try again.');
  }
};

const processBackupFile = async (file) => {
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    
    if (!data.version || !data.timestamp) {
      throw new Error('Invalid backup file format');
    }

    showConfirm(
      'Restore Backup', 
      `This will replace all current data with backup from ${formatDate(data.timestamp)}. Continue?`,
      async () => {
        await performRestore(data, file.name);
      }
    );
  } catch (e) {
    console.error('processBackupFile', e);
    showAlert('Error', 'Invalid backup file. Please select a valid backup.');
  }
};

const performRestore = async (data, fileName) => {
  try {
    // Smart merge logic for cross-role compatibility
    const mergeData = async (tableName, backupRecords) => {
      const existing = await localDB[tableName].toArray();
      const merged = new Map();

      // Add existing records first
      existing.forEach(record => {
        const key = record.remoteId || record.mrn || record.id;
        merged.set(key, record);
      });

      // Merge backup records
      backupRecords.forEach(record => {
        const key = record.remoteId || record.mrn || record.id;
        const existingRecord = merged.get(key);
        
        if (!existingRecord) {
          // New record from backup
          merged.set(key, { ...record, updatedAt: nowIso() });
        } else {
          // Merge with conflict resolution
          const resolved = resolveRecord(existingRecord, record, tableName);
          merged.set(key, { ...resolved, updatedAt: nowIso() });
        }
      });

      return Array.from(merged.values());
    };

    // Clear and restore tables
    const tablesToRestore = ['patients', 'sales', 'purchases', 'expenses', 'inventory', 'activityLogs'];
    
    await localDB.transaction('rw', tablesToRestore.map(t => localDB[t]), async () => {
      for (const table of tablesToRestore) {
        if (data[table] && Array.isArray(data[table])) {
          const mergedData = await mergeData(table, data[table]);
          await localDB[table].clear();
          await localDB[table].bulkAdd(mergedData);
        }
      }
    });

    await recordBackupHistory(fileName, 'Restore', 0, 'Success');
    await logActivity('restore', 'backup', `Data restored from ${fileName}`);
    
    // Force sync after restore
    await scheduleSyncNow('restore-complete');
    await triggerDataSync(['dashboard', 'inventory', 'sales', 'purchases', 'expenses', 'logs']);
    
    showToast('Backup restored successfully', 'success');
    loadBackupHistory();
  } catch (e) {
    console.error('performRestore', e);
    await recordBackupHistory(fileName || 'unknown', 'Restore', 0, 'Failed');
    showAlert('Error', 'Failed to restore backup. Please try again.');
  }
};

const loadBackupHistory = async () => {
  try {
    const history = await localDB.backupHistory.orderBy('date').reverse().toArray();
    const tbody = el('backupHistoryBody');
    tbody.innerHTML = '';
    
    if (!history.length) {
      el('backupEmptyState')?.classList.remove('hidden');
      return;
    } else {
      el('backupEmptyState')?.classList.add('hidden');
    }

    for (const entry of history) {
      const tr = document.createElement('tr');
      const statusColor = entry.status === 'Success' ? '#10B981' : '#EF4444';
      const statusIcon = entry.status === 'Success' ? '‚úì' : '‚úó';
      
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold text-gray-900 dark:text-white">${formatDate(entry.date)} ${formatTime(entry.date)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${entry.type}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${entry.size}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm+ font-extrabold" style="color: ${statusColor};">${statusIcon} ${entry.status}</td>
        <td class="px-6 py-4 text-sm+ text-gray-800 dark:text-gray-100 font-semibold">${entry.fileName || 'N/A'}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) {
    console.error('loadBackupHistory', e);
  }
};

// Receipt generation
const showReceiptPreview = async (sale) => {
  try {
    const patient = await localDB.patients.where('mrn').equals(sale.patientMrn).first();
    const receiptContent = el('receiptContent');
    
    let drugsHtml = '';
    let total = 0;
    
    if (Array.isArray(sale.drugs)) {
      for (const drug of sale.drugs) {
        const price = await calculateDrugSellingPrice(drug.name, drug.dose, drug.unit);
        const subtotal = Number(drug.quantity) * price;
        total += subtotal;
        
        drugsHtml += `
          <tr>
            <td>${drug.name}</td>
            <td>${drug.dose}</td>
            <td style="text-align: center">${drug.quantity}</td>
            <td style="text-align: right">${formatCurrency(price)}</td>
            <td style="text-align: right; font-weight: bold">${formatCurrency(subtotal)}</td>
          </tr>
        `;
      }
    }

    receiptContent.innerHTML = `
      <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #5D5CDE; padding-bottom: 15px;">
        <h2 style="margin: 0; color: #5D5CDE; font-size: 18px; font-weight: bold;">Sheikh Bakri Saphalo Medium Clinic</h2>
        <p style="margin: 5px 0 0; font-size: 12px; color: #666;">Professional Pharmacy Management</p>
        <p style="margin: 5px 0 0; font-size: 12px; color: #666;">Receipt #${sale.id || 'N/A'}</p>
      </div>
      
      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 8px; font-size: 14px; color: #333;">Patient Information</h3>
        <table style="width: 100%; font-size: 12px;">
          <tr><td><strong>MRN:</strong></td><td>${sale.patientMrn}</td></tr>
          <tr><td><strong>Name:</strong></td><td>${patient?.name || 'Unknown'}</td></tr>
          <tr><td><strong>Age:</strong></td><td>${patient?.age || 'N/A'}</td></tr>
          <tr><td><strong>Sex:</strong></td><td>${patient?.sex || 'N/A'}</td></tr>
        </table>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 8px; font-size: 14px; color: #333;">Prescribed Medications</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Drug</th>
              <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Dose</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd;">Qty</th>
              <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">Price</th>
              <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${drugsHtml}
          </tbody>
        </table>
      </div>

       <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #5D5CDE;">
        <table style="width: 100%; font-size: 12px;">
          <tr><td><strong>Total Amount:</strong></td><td style="text-align: right; font-weight: bold; color: #10B981;">${formatCurrency(sale.totalPaid)}</td></tr>
          <tr><td><strong>Date:</strong></td><td style="text-align: right;">${formatDate(sale.timestamp)}</td></tr>
          <tr><td><strong>Time:</strong></td><td style="text-align: right;">${formatTime(sale.timestamp)}</td></tr>
          <tr><td><strong>Served by:</strong></td><td style="text-align: right;">${sale.createdByEmail || sale.createdBy}</td></tr>
        </table>
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 10px; color: #666;">
        <p style="margin: 0;">Thank you for choosing our pharmacy!</p>
        <p style="margin: 5px 0 0;">Please keep this receipt for your records.</p>
      </div>
    `;
    
    openModal('receiptModal');
  } catch (e) {
    console.error('showReceiptPreview', e);
    showAlert('Error', 'Failed to generate receipt preview.');
  }
};

// Print receipt functionality
    // Enhanced mobile-friendly print functionality
const printReceipt = () => {
  const receiptContent = el('receiptContent');
  if (!receiptContent) return;
  
  // Check if device is mobile
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
  
  if (isMobile) {
    // Mobile-friendly approach: Create full-screen print view
    createMobilePrintView(receiptContent);
  } else {
    // Desktop approach: Use window.open
    createDesktopPrintView(receiptContent);
  }
};

const createMobilePrintView = (receiptContent) => {
  // Create a full-screen overlay for mobile print
  const printOverlay = document.createElement('div');
  printOverlay.id = 'mobilePrintOverlay';
  printOverlay.className = 'fixed inset-0 bg-white z-[9999] overflow-y-auto';
  printOverlay.innerHTML = `
    <div class="min-h-screen">
      <!-- Mobile Print Header -->
      <div class="sticky top-0 bg-white border-b-2 border-gray-200 p-4 flex justify-between items-center print:hidden">
        <h3 class="text-lg font-bold text-gray-900">Receipt Preview</h3>
        <div class="flex gap-2">
          <button id="mobilePrintBtn" class="bg-primary text-white px-4 py-2 rounded-lg font-bold">üñ®Ô∏è Print</button>
          <button id="closeMobilePrint" class="bg-gray-500 text-white px-4 py-2 rounded-lg font-bold">‚úï Close</button>
        </div>
      </div>
      
      <!-- Print Content -->
      <div id="mobilePrintContent" class="p-4 max-w-md mx-auto">
        ${receiptContent.innerHTML}
      </div>
      
      <!-- Mobile Print Instructions -->
      <div class="p-4 bg-blue-50 border-t border-blue-200 text-center print:hidden">
        <p class="text-sm text-blue-700 font-semibold">üì± Mobile Print Instructions:</p>
        <p class="text-xs text-blue-600 mt-1">Tap "Print" ‚Üí Select your printer ‚Üí Choose "Save as PDF" if no printer available</p>
      </div>
    </div>
  `;
  
  document.body.appendChild(printOverlay);
  
  // Add print styles for mobile
  const printStyles = document.createElement('style');
  printStyles.textContent = `
    @media print {
      #mobilePrintOverlay {
        position: static !important;
        z-index: auto !important;
        background: white !important;
      }
      #mobilePrintContent {
        padding: 0 !important;
        max-width: 100% !important;
        margin: 0 !important;
      }
      .print\\:hidden {
        display: none !important;
      }
    }
  `;
  document.head.appendChild(printStyles);
  
  // Event listeners
  document.getElementById('mobilePrintBtn').addEventListener('click', () => {
    window.print();
  });
  
  document.getElementById('closeMobilePrint').addEventListener('click', () => {
    document.body.removeChild(printOverlay);
    document.head.removeChild(printStyles);
  });
  
  // Close on escape key
  const handleEscape = (e) => {
    if (e.key === 'Escape') {
      document.body.removeChild(printOverlay);
      document.head.removeChild(printStyles);
      document.removeEventListener('keydown', handleEscape);
    }
  };
  document.addEventListener('keydown', handleEscape);
};

const createDesktopPrintView = (receiptContent) => {
  const printWindow = window.open('', '_blank', 'width=600,height=800');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Receipt - Sheikh Bakri Saphalo Medium Clinic</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { 
          font-family: Arial, sans-serif; 
          margin: 20px; 
          line-height: 1.4;
        }
        table { 
          border-collapse: collapse; 
          width: 100%;
        }
        th, td { 
          padding: 8px 4px; 
          border: 1px solid #ddd;
        }
        th {
          background-color: #f5f5f5;
          font-weight: bold;
        }
        .no-print {
          display: block;
          text-align: center;
          margin: 20px 0;
          padding: 10px;
          background: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 5px;
        }
        @media print { 
          body { margin: 0; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="no-print">
        <button onclick="window.print()" style="background: #5D5CDE; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">üñ®Ô∏è Print Receipt</button>
        <button onclick="window.close()" style="background: #6B7280; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-left: 10px;">‚úï Close</button>
      </div>
      ${receiptContent.innerHTML}
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
};
  
// -------------- Event Handlers --------------

// Navigation
document.addEventListener('click', (e) => {
  const navBtn = e.target.closest('.nav-btn');
  if (!navBtn) return;
  const section = navBtn.getAttribute('data-section');
  showSection(section + 'Section');
  
  // Load section data if needed
  switch (section) {
    case 'dashboard': updateDashboardStats(); break;
    case 'sales': loadSalesTable(); break;
    case 'purchases': loadPurchasesTable(); break;
    case 'inventory': loadInventoryTable(); break;
    case 'expenses': loadExpensesTable(); break;
    case 'logs': loadLogsTable(); break;
    case 'backup': loadBackupHistory(); break;
  }
});

// Modal close buttons
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-close')) {
    const modal = e.target.closest('.modal');
    if (modal) closeModal(modal.id);
  }
});

// Add buttons
el('addSaleBtn')?.addEventListener('click', async () => {
  el('saleForm').reset();
  el('drugsContainer').innerHTML = '';
  addDrugRow();
  el('patientMRN').value = await generateNextMRN();
  setupPatientSearch();
  openModal('addSaleModal');
});

el('addPurchaseBtn')?.addEventListener('click', () => {
  el('purchaseForm').reset();
  editingPurchaseId = null;
  el('purchaseModalTitle').textContent = 'New Purchase';
  el('purchaseSubmitBtn').textContent = 'Add Purchase';
  el('purchaseId').value = '';
  openModal('addPurchaseModal');
});

el('addExpenseBtn')?.addEventListener('click', () => {
  el('expenseForm').reset();
  openModal('addExpenseModal');
});

el('addDrugBtn')?.addEventListener('click', addDrugRow);

// Purchase calculation
el('purchaseQuantity')?.addEventListener('input', calculatePurchaseTotal);
el('purchaseUnitPrice')?.addEventListener('input', calculatePurchaseTotal);

// Form submissions
el('saleForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const drugRows = document.querySelectorAll('.drug-row');
  
  if (!drugRows.length) {
    showAlert('Validation Error', 'Please add at least one drug.');
    return;
  }

  const drugs = [];
  let hasValidDrug = false;
  
  for (const row of drugRows) {
    const name = row.querySelector('[name="drugName"]')?.value?.trim();
    const dose = row.querySelector('[name="drugDose"]')?.value?.trim();
    const unit = row.querySelector('[name="drugUnit"]')?.value?.trim();
    const quantity = parseFloat(row.querySelector('[name="drugQuantity"]')?.value) || 0;
    
    if (name && dose && unit && quantity > 0) {
      drugs.push({ name, dose, unit, quantity });
      hasValidDrug = true;
    }
  }

  if (!hasValidDrug) {
    showAlert('Validation Error', 'Please add at least one valid drug with quantity.');
    return;
  }

  const saleData = {
    mrn: formData.get('patientMRN') || el('patientMRN').value,
    patientName: formData.get('patientName') || el('patientName').value,
    patientAge: parseInt(formData.get('patientAge') || el('patientAge').value),
    patientSex: formData.get('patientSex') || el('patientSex').value,
    patientAddress: formData.get('patientAddress') || el('patientAddress').value,
    diagnosis: formData.get('patientDiagnosis') || el('patientDiagnosis').value,
    totalPaid: parseFloat(formData.get('totalPaid') || el('totalPaid').value) || 0,
    drugs
  };

  // Validation
  if (!saleData.mrn || saleData.mrn.length !== 5) {
    showAlert('Validation Error', 'Please enter a valid 5-digit MRN.');
    return;
  }
  if (!saleData.patientName) {
    showAlert('Validation Error', 'Please enter patient name.');
    return;
  }
  if (!saleData.totalPaid || saleData.totalPaid <= 0) {
    showAlert('Validation Error', 'Please enter a valid payment amount.');
    return;
  }

  const result = await saveSale(saleData);
  if (result.success) {
    closeModal('addSaleModal');
    showToast('Sale recorded successfully', 'success');
    await triggerDataSync(['sales', 'dashboard', 'inventory']);
    
    // Ask if user wants to print receipt
    showConfirm('Print Receipt', 'Sale recorded successfully. Would you like to print the receipt?', () => {
      showReceiptPreview(result.record);
    });
  }
});

el('purchaseForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  
  const purchaseData = {
    drugName: formData.get('drugName') || el('purchaseDrugName').value,
    dose: formData.get('dose') || el('purchaseDose').value,
    unit: formData.get('unit') || el('purchaseUnit').value,
    quantity: parseFloat(formData.get('quantity') || el('purchaseQuantity').value) || 0,
    unitPrice: parseFloat(formData.get('unitPrice') || el('purchaseUnitPrice').value) || 0,
    supplier: formData.get('supplier') || el('purchaseSupplier').value,
    expiryDate: formData.get('expiryDate') || el('purchaseExpiryDate').value
  };

  // Validation
  if (!purchaseData.drugName || !purchaseData.dose || !purchaseData.unit) {
    showAlert('Validation Error', 'Please fill in all drug information.');
    return;
  }
  if (purchaseData.quantity <= 0 || purchaseData.unitPrice <= 0) {
    showAlert('Validation Error', 'Please enter valid quantity and unit price.');
    return;
  }
  if (!purchaseData.supplier) {
    showAlert('Validation Error', 'Please enter supplier information.');
    return;
  }
  if (!purchaseData.expiryDate) {
    showAlert('Validation Error', 'Please enter expiry date.');
    return;
  }

  const success = await savePurchase(purchaseData);
  if (success) {
    closeModal('addPurchaseModal');
    await triggerDataSync(['purchases', 'inventory', 'dashboard']);
  }
});

el('expenseForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  
  const expenseData = {
    type: formData.get('type') || el('expenseType').value,
    amount: parseFloat(formData.get('amount') || el('expenseAmount').value) || 0,
    description: formData.get('description') || el('expenseDescription').value
  };

  // Validation
  if (!expenseData.type) {
    showAlert('Validation Error', 'Please select expense type.');
    return;
  }
  if (expenseData.amount <= 0) {
    showAlert('Validation Error', 'Please enter a valid amount.');
    return;
  }
  if (!expenseData.description) {
    showAlert('Validation Error', 'Please enter expense description.');
    return;
  }

  const success = await saveExpense(expenseData);
  if (success) {
    closeModal('addExpenseModal');
    showToast('Expense recorded successfully', 'success');
    await triggerDataSync(['expenses', 'dashboard']);
  }
});

// Authentication
   el('loginForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = el('loginEmail').value;
  const password = el('loginPassword').value;
  
  if (!email || !password) {
    showAlert('Validation Error', 'Please enter both email and password.');
    return;
  }

  const loginBtn = el('loginButtonText');
  const spinner = el('loginSpinner');
  
  loginBtn.textContent = 'Signing in...';
  spinner.style.display = 'block';

  try {
    const result = await authenticateUser(email, password);
    if (result.success) {
      currentUser = result.user;
      currentUserEmail = result.user.email;
      currentUserUUID = result.user.uuid;
      
      // Initialize main app
      el('authScreen').classList.add('hidden');
      el('mainApp').classList.remove('hidden');
      el('userName').textContent = result.user.email;
      el('userRole').textContent = result.user.role;

      // Apply role restrictions and initialize charts for admin
      applyRoleRestrictions();
      initializeCharts();

      // Load dashboard (numbers + feed chart data)
      await triggerDataSync(['dashboard']);

      // Setup real-time sync and listeners only if online with Firebase
      if (result.user.offline) {
        console.log('üì± User authenticated offline');
        updateSyncStatus('offline', 'üî¥', 'Offline Mode', false);
        showToast(`Welcome back, ${result.user.role}! (Offline Mode)`, 'info');
      } else {
        console.log('üåê User authenticated online');
        await scheduleSyncNow('login-complete');
        updateOnlineStatusUI();
        showToast(`Welcome back, ${result.user.role}!`, 'success');
      }
      
    } else {
      showAlert('Login Failed', result.error);
    }
  } catch (e) {
    console.error('Login error:', e);
    showAlert('Error', 'Login failed. Please try again.');
  } finally {
    loginBtn.textContent = 'Sign In';
    spinner.style.display = 'none';
  }
});

el('signupForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = el('signupEmail').value;
  const password = el('signupPassword').value;
  const confirmPassword = el('signupConfirmPassword').value;
  const role = el('signupRole').value;

  if (!email || !password || !confirmPassword || !role) {
    showAlert('Validation Error', 'Please fill in all fields.');
    return;
  }
  if (password !== confirmPassword) {
    showAlert('Validation Error', 'Passwords do not match.');
    return;
  }
  if (password.length < 6) {
    showAlert('Validation Error', 'Password must be at least 6 characters long.');
    return;
  }

  const signupBtn = el('signupButtonText');
  const spinner = el('signupSpinner');
  
  signupBtn.textContent = 'Creating account...';
  spinner.style.display = 'block';

  try {
    const result = await signUpUser(email, password, role);
    if (result.success) {
      showToast(result.message, 'success');
      toggleAuthMode(); // Switch back to login
    } else {
      showAlert('Signup Failed', result.error);
    }
  } catch (e) {
    console.error('Signup error:', e);
    showAlert('Error', 'Signup failed. Please try again.');
  } finally {
    signupBtn.textContent = 'Sign Up';
    spinner.style.display = 'none';
  }
});

el('toggleAuthMode')?.addEventListener('click', toggleAuthMode);

    // Logout
el('logoutBtn')?.addEventListener('click', () => {
  showConfirm('Logout', 'Are you sure you want to logout?', async () => {
    await logoutUser();
    
    // Reset UI
    el('mainApp').classList.add('hidden');
    el('authScreen').classList.remove('hidden');
    el('loginForm').reset();
    el('signupForm').reset();
    
    showToast('Logged out successfully', 'info');
    updateOnlineStatusUI();
  });
});

// Dark mode toggle
el('toggleDarkMode')?.addEventListener('click', () => {
  const isDark = document.documentElement.classList.contains('dark');
  setDarkMode(!isDark);
});

// Reports
document.addEventListener('click', (e) => {
  const reportBtn = e.target.closest('.report-btn');
  if (!reportBtn) return;
  const reportType = reportBtn.getAttribute('data-report');
  generateReport(reportType);
});

el('exportPdfBtn')?.addEventListener('click', exportToPDF);
el('exportCsvBtn')?.addEventListener('click', exportToCSV);

// Date range for reports
el('reportDateRangeBtn')?.addEventListener('click', () => {
  const today = new Date();
  el('dateFrom').value = new Date(today.getTime() - 30*24*60*60*1000).toISOString().slice(0,10);
  el('dateTo').value = today.toISOString().slice(0,10);
  openModal('dateRangeModal');
});

el('applyDateRangeBtn')?.addEventListener('click', () => {
  const from = el('dateFrom').value;
  const to = el('dateTo').value;
  if (from && to && currentReportKey) {
    currentReportRange = { from, to };
    generateReport(currentReportKey);
    closeModal('dateRangeModal');
  } else {
    showAlert('Error', 'Please select valid date range.');
  }
});

// Filters
el('salesDateFilter')?.addEventListener('change', loadSalesTable);
el('salesSearchFilter')?.addEventListener('input', debounce(loadSalesTable, 300));
el('inventorySearchFilter')?.addEventListener('input', debounce(loadInventoryTable, 300));
el('inventoryStatusFilter')?.addEventListener('change', loadInventoryTable);
el('inventorySupplierFilter')?.addEventListener('input', debounce(loadInventoryTable, 300));
el('refreshInventoryBtn')?.addEventListener('click', loadInventoryTable);
el('logsUserFilter')?.addEventListener('change', loadLogsTable);
el('logsActionFilter')?.addEventListener('change', loadLogsTable);
el('logsDateFilter')?.addEventListener('change', loadLogsTable);
el('refreshLogsBtn')?.addEventListener('click', loadLogsTable);

// Backup & Restore
el('chooseFolderBtn')?.addEventListener('click', chooseFolder);
el('manualBackupBtn')?.addEventListener('click', backupData);
el('manualRestoreBtn')?.addEventListener('click', restoreLatestBackup);
el('restoreLocalBtn')?.addEventListener('click', () => el('restoreLocalInput').click());
el('restoreLocalInput')?.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) processBackupFile(file);
});
el('forceSyncBtn')?.addEventListener('click', forceSync);
el('clearLocalDataBtn')?.addEventListener('click', clearLocalData);

// Receipt and Print
el('printReceiptBtn')?.addEventListener('click', async () => {
  const drugRows = document.querySelectorAll('.drug-row');
  if (!drugRows.length) {
    showAlert('Error', 'Please add drugs first.');
    return;
  }
  
  // Create a temporary sale object for preview
  const tempSale = {
    id: 'PREVIEW',
    patientMrn: el('patientMRN').value,
    totalPaid: parseFloat(el('totalPaid').value) || 0,
    timestamp: new Date(),
    createdByEmail: currentUserEmail,
    drugs: []
  };

  for (const row of drugRows) {
    const name = row.querySelector('[name="drugName"]')?.value?.trim();
    const dose = row.querySelector('[name="drugDose"]')?.value?.trim();
    const unit = row.querySelector('[name="drugUnit"]')?.value?.trim();
    const quantity = parseFloat(row.querySelector('[name="drugQuantity"]')?.value) || 0;
    if (name && dose && unit && quantity > 0) {
      tempSale.drugs.push({ name, dose, unit, quantity });
    }
  }

  showReceiptPreview(tempSale);
});

el('printReceiptAction')?.addEventListener('click', printReceipt);

// Alert and Confirm dialog handlers
el('alertOk')?.addEventListener('click', () => closeModal('alertDialog'));
el('confirmCancel')?.addEventListener('click', () => closeModal('confirmDialog'));

// Debounce utility
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

    // -------------- Initialization --------------
    const initializeApp = async () => {
  try {
    console.log('üöÄ Starting Saladin Pharma initialization...');
    
    // Initialize dark mode
    initDarkMode();
    
    // Update datetime periodically
    updateDateTime();
    setInterval(updateDateTime, 30000);

    // Setup initial sync status
    updateOnlineStatusUI();
    updateCloudSyncStatus();

    // Load backup history
    await loadBackupHistory();

    // Initialize folder status
    updateFolderStatus();

    // Check for cached credentials and auto-fill login
    await attemptAutoLogin();

    // Wait for Firebase to be ready before setting up auth and sync
    const waitForFirebase = () => {
      if (window.isFirebaseReady && window.isFirebaseReady()) {
        console.log('‚úÖ Firebase is ready, setting up auth listener...');
        setupFirebaseAuthListener();
        
        // Initialize charts for admin users after Firebase is ready
        setTimeout(initializeCharts, 100);
        
        console.log('‚úÖ Saladin Pharma initialized successfully');
      } else {
        console.log('‚è≥ Waiting for Firebase to be ready...');
        setTimeout(waitForFirebase, 500);
      }
    };

    // Listen for Firebase ready event
    window.addEventListener('firebaseReady', () => {
      console.log('üî• Firebase ready event received');
      setupFirebaseAuthListener();
      setTimeout(initializeCharts, 100);
      updateOnlineStatusUI();
    });

    // Start waiting for Firebase
    waitForFirebase();
    
  } catch (error) {
    console.error('Initialization error:', error);
    showAlert('Initialization Error', 'Failed to initialize the application. Please refresh the page.');
  }
};

    // Start the application
    document.addEventListener('DOMContentLoaded', initializeApp);

  // Additional error handling
window.addEventListener('error', (e) => {
  console.error('Global error:', e.error);
  showToast('An unexpected error occurred', 'error');
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('Unhandled promise rejection:', e.reason);
  e.preventDefault();
});

// Expose some globals for debugging (only in development)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  window.SaladinPharma = {
    localDB,
    currentUser,
    generateReport,
    fullSync,
    showToast,
    showAlert,
    showConfirm
  };
}
  </script>
</body>
</html>
